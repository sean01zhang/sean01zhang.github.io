<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-05-02 Tue 11:44 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metal</title>
<meta name="author" content="Sean Zhang" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Metal
<br />
<span class="subtitle">Using Metal API for Compute</span>
</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org4ddce22">1. Introduction</a></li>
<li><a href="#orgb545431">2. Project Structure</a>
<ul>
<li><a href="#org6414404">2.1. Source Files</a></li>
<li><a href="#org5bc8a65">2.2. Building Project</a></li>
</ul>
</li>
<li><a href="#org409527e">3. Initialization</a></li>
<li><a href="#org0022cbf">4. Our shader code</a></li>
<li><a href="#org08df108">5. Running the project</a>
<ul>
<li><a href="#org423934f">5.1. Compiling Your Metal Library</a></li>
<li><a href="#orga7e342a">5.2. Running your code</a></li>
</ul>
</li>
<li><a href="#org0bc296a">6. Next Steps</a></li>
<li><a href="#orgfb411b7">7. Addendum</a>
<ul>
<li><a href="#org1d5dfb4">7.1. Simd</a></li>
<li><a href="#orgb194499">7.2. Compiling multiple metal files</a></li>
<li><a href="#org232b6db">7.3. Randomness</a></li>
<li><a href="#orga71149c">7.4. Writing to a 2D Output Buffer</a>
<ul>
<li><a href="#orga5e0bf8">7.4.1. Textures</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org4ddce22" class="outline-2">
<h2 id="org4ddce22"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">This is a work-in-progress</td>
</tr>
</tbody>
</table>

<p>
I wanted to use the GPU for some intesive tasks in C++. However, I have a macbook so
I guess we can try it using metal. Here is a note to self on how to do it.
To make it clear, this is my first time working with CMake.
</p>
</div>
</div>

<div id="outline-container-orgb545431" class="outline-2">
<h2 id="orgb545431"><span class="section-number-2">2.</span> Project Structure</h2>
<div class="outline-text-2" id="text-2">
<p>
We will need the metal-cpp library from Apple first. Then, place that into a folder called
<code>lib</code>, under the root of the project. <br />
Then, we will use cmake to generate build files for the project.
This is all new to me, so I decided to quickly ask Bing chat what it thought was
a good idea:
</p>
<pre class="example">
Here are some steps to set up a basic CMake that includes the Metal APIs:
1. First, you need to install CMake on your system. You can download it from the official website.
2. Next, you need to create a new CMake project and add the Metal APIs to it. You can do this by adding the following lines to your CMakeLists.txt file:

```
cmake_minimum_required(VERSION 3.0)
project(MyMetalProject)

set(CMAKE_CXX_STANDARD 14)

find_library(METAL_LIBRARY Metal)
find_library(CORE_FOUNDATION_LIBRARY CoreFoundation)

add_executable(MyMetalProject main.cpp)

target_link_libraries(MyMetalProject ${METAL_LIBRARY} ${CORE_FOUNDATION_LIBRARY})
```

3. Now you can create a new file called main.cpp and add some code that uses the Metal APIs.

4. Finally, you can build your project using CMake and run it.

I hope this helps! Let me know if you have any other questions.
</pre>
</div>

<div id="outline-container-org6414404" class="outline-3">
<h3 id="org6414404"><span class="section-number-3">2.1.</span> Source Files</h3>
<div class="outline-text-3" id="text-2-1">
<p>
We will put the code under a folder called <code>src/</code>. We name our starting point <code>main.cpp</code>, but you can
name it something else if you please. Just make sure you update the Cmake file.
</p>
</div>
</div>

<div id="outline-container-org5bc8a65" class="outline-3">
<h3 id="org5bc8a65"><span class="section-number-3">2.2.</span> Building Project</h3>
<div class="outline-text-3" id="text-2-2">
<p>
First, we have to configure cmake. This is a bit different from the CMakeLists suggested from Bing above.
I encountered problems with <code>find_library</code> finding the <code>CoreFoundation</code> library. I specified <code>NO_DEFAULT_PATH</code>, which resolved it finding a CoreFoundation library on my
system rather than in the project, but then it couldn't find the one in my project even when I gave it hints.
Instead, I decided to ditch that and manually input the frameworks as shown:
</p>

<p>
<b>CMakeLists.txt</b>
</p>
<div class="org-src-container">
<pre class="src src-c">cmake_minimum_required <span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">VERSION</span> <span style="color: #0000c0;">3.20</span><span style="color: #000000; background-color: #ffffff;">)</span>
<span style="color: #721045;">project</span> <span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">compute_sumarrays</span><span style="color: #000000; background-color: #ffffff;">)</span>

set<span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">CMAKE_CXX_STANDARD</span> <span style="color: #0000c0;">17</span><span style="color: #000000; background-color: #ffffff;">)</span>
<span style="color: #a0132f;"># set</span><span style="color: #000000;">(</span>CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Werror"<span style="color: #000000;">)</span>

include_directories<span style="color: #000000; background-color: #ffffff;">(</span>$<span style="color: #a8007f; background-color: #ffffff;">{</span><span style="color: #0000c0;">CMAKE_SOURCE_DIR</span><span style="color: #a8007f; background-color: #ffffff;">}</span><span style="color: #5317ac;">/</span>lib<span style="color: #5317ac;">/</span>metal<span style="color: #5317ac;">-</span>cpp<span style="color: #000000; background-color: #ffffff;">)</span>

<span style="color: #0000c0;">add_executable</span><span style="color: #000000; background-color: #ffffff;">(</span>compute_sumarrays
  <span style="color: #000000; background-color: #ffffff;">.</span><span style="color: #5317ac;">/</span><span style="color: #0000c0; font-style: italic;">src</span><span style="color: #5317ac;">/</span>main<span style="color: #000000; background-color: #ffffff;">.</span><span style="color: #0000c0; font-style: italic;">cc</span>
<span style="color: #000000; background-color: #ffffff;">)</span>

target_link_libraries<span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">compute_sumarrays</span>
  stdc<span style="color: #5317ac;">++</span> 
  <span style="color: #2544bb;">"-framework Metal"</span>
  <span style="color: #2544bb;">"-framework Foundation"</span>
  <span style="color: #2544bb;">"-framework QuartzCore"</span>
  objc
<span style="color: #000000; background-color: #ffffff;">)</span>
</pre>
</div>

<p>
Place this file in the root of your directory. The reason why I commented out the flags
is because one of the header files in the metal-cpp library is triggering a warning.
</p>

<p>
Now that your <code>CMakeLists.txt</code> file is set up, here is what to do next:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #505050;"># you should be in the root of your project</span>
<span style="color: #8f0075;">pwd</span>

<span style="color: #0000c0;">mkdir</span> build
<span style="color: #8f0075;">cd</span> build
<span style="color: #505050;"># start configuration, 2nd argument is</span>
<span style="color: #505050;"># the path to the CMakeLists.txt directory.</span>
<span style="color: #0000c0;">cmake</span> ../
</pre>
</div>

<p>
This will generate a Makefile in your <code>build</code> directory.
You do not need to do anything to that file. When ready to
build, just type <code>make</code> in that directory, and it will
create an executable which will have the same name as your project.
</p>
</div>
</div>
</div>

<div id="outline-container-org409527e" class="outline-2">
<h2 id="org409527e"><span class="section-number-2">3.</span> Initialization</h2>
<div class="outline-text-2" id="text-3">
<p>
Once all the structure is there, we move on to the main file of our project.
We need to set up a compute pipeline for metal. I referenced <a href="https://developer.apple.com/documentation/metal/performing_calculations_on_a_gpu?language=objc">this</a> to help me get started.
There are a few changes that I made, the first one being that I need to import the metal library by providing the path
to a compiled <code>.metallib</code> file (more on that later). Everything else is mostly the same.
</p>

<div class="org-src-container">
<pre class="src src-C++" id="orgd5b54d3"><span style="color: #a0132f;">#define</span> <span style="color: #702f00;">NS_PRIVATE_IMPLEMENTATION</span>
<span style="color: #a0132f;">#define</span> <span style="color: #702f00;">CA_PRIVATE_IMPLEMENTATION</span>
<span style="color: #a0132f;">#define</span> <span style="color: #702f00;">MTL_PRIVATE_IMPLEMENTATION</span>
<span style="color: #a0132f;">#include</span> <span style="color: #2544bb;">&lt;Foundation/Foundation.hpp&gt;</span>
<span style="color: #a0132f;">#include</span> <span style="color: #2544bb;">&lt;Metal/Metal.hpp&gt;</span>
<span style="color: #a0132f;">#include</span> <span style="color: #2544bb;">&lt;QuartzCore/QuartzCore.hpp&gt;</span>

<span style="color: #a0132f;">#include</span> <span style="color: #2544bb;">&lt;iostream&gt;</span>

<span style="color: #8f0075;">int</span> <span style="color: #721045;">main</span><span style="color: #000000; background-color: #ffffff;">()</span> <span style="color: #000000; background-color: #ffffff;">{</span>
  <span style="color: #505050;">// create device</span>
  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Device</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">device</span> <span style="color: #5317ac;">=</span> <span style="color: #005a5f;">MTL</span>::<span style="color: #0000c0;">CreateSystemDefaultDevice</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #005a5f;">NS</span>::<span style="color: #005a5f;">Error</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">error</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #505050;">// create command queue</span>
  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">CommandQueue</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">command_queue</span> <span style="color: #5317ac;">=</span> device<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">newCommandQueue</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #505050;">// create command buffer</span>
  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">CommandBuffer</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">command_buffer</span> <span style="color: #5317ac;">=</span> command_queue<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">commandBuffer</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #505050;">// create command encoder</span>
  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">ComputeCommandEncoder</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">command_encoder</span> <span style="color: #5317ac;">=</span> command_buffer<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">computeCommandEncoder</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #505050;">// ** Create pipeline state object</span>
  <span style="color: #005a5f;">NS</span>::<span style="color: #005a5f;">String</span><span style="color: #5317ac;">*</span> <span style="color: #00538b;">libPath</span> <span style="color: #5317ac;">=</span> <span style="color: #005a5f;">NS</span>::<span style="color: #0000c0;">String</span><span style="color: #0000c0;">::string</span><span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #2544bb;">"./shader.metallib"</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #005a5f;">NS</span>::UTF8StringEncoding<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #005a5f;">auto</span> <span style="color: #00538b;">default_library</span> <span style="color: #5317ac;">=</span> device<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">newLibrary</span><span style="color: #a8007f; background-color: #ffffff;">(</span>libPath<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #5317ac;">&amp;</span>error<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #5317ac;">if</span> <span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #5317ac;">!</span>default_library<span style="color: #a8007f; background-color: #ffffff;">)</span> <span style="color: #a8007f; background-color: #ffffff;">{</span>
    <span style="color: #005a5f;">std</span>::cerr <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #2544bb;">"Failed to load default library."</span><span style="color: #000000; background-color: #ffffff;">;</span>
    <span style="color: #005a5f;">std</span>::<span style="color: #0000c0;">exit</span><span style="color: #005f88; background-color: #ffffff;">(</span><span style="color: #0000c0;">-1</span><span style="color: #005f88; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #a8007f; background-color: #ffffff;">}</span>

  <span style="color: #005a5f;">auto</span> <span style="color: #00538b;">add_arrays_function_name</span> <span style="color: #5317ac;">=</span> <span style="color: #005a5f;">NS</span>::<span style="color: #0000c0;">String</span><span style="color: #0000c0;">::string</span><span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #2544bb;">"add_arrays"</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #005a5f;">NS</span>::ASCIIStringEncoding<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #005a5f;">auto</span> <span style="color: #00538b;">add_function</span> <span style="color: #5317ac;">=</span> default_library<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">newFunction</span><span style="color: #a8007f; background-color: #ffffff;">(</span>add_arrays_function_name<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #5317ac;">if</span> <span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #5317ac;">!</span>add_function<span style="color: #a8007f; background-color: #ffffff;">)</span> <span style="color: #a8007f; background-color: #ffffff;">{</span>
    <span style="color: #005a5f;">std</span>::cerr <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #2544bb;">"failed to find the adder function"</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #a8007f; background-color: #ffffff;">}</span>

  <span style="color: #005a5f;">auto</span> <span style="color: #00538b;">pso</span> <span style="color: #5317ac;">=</span> device<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">newComputePipelineState</span><span style="color: #a8007f; background-color: #ffffff;">(</span>add_function<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #5317ac;">&amp;</span>error<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #505050;">// free defualt library and add function</span>
  add_arrays_function_name<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  default_library<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  add_function<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #505050;">// pass pipeline state object created</span>
  <span style="color: #505050;">// into the command encoder</span>
  command_encoder<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setComputePipelineState</span><span style="color: #a8007f; background-color: #ffffff;">(</span>pso<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>


  <span style="color: #505050;">// ** Create data buffers</span>
  <span style="color: #505050;">// TODO: Make data and determine its size</span>
  <span style="color: #8f0075;">int</span> <span style="color: #00538b;">array1</span><span style="color: #a8007f; background-color: #ffffff;">[]</span> <span style="color: #5317ac;">=</span> <span style="color: #a8007f; background-color: #ffffff;">{</span><span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">2</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">3</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">4</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">5</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">6</span><span style="color: #a8007f; background-color: #ffffff;">}</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #8f0075;">int</span> <span style="color: #00538b;">array2</span><span style="color: #a8007f; background-color: #ffffff;">[]</span> <span style="color: #5317ac;">=</span> <span style="color: #a8007f; background-color: #ffffff;">{</span><span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #a8007f; background-color: #ffffff;">}</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #8f0075;">size_t</span> <span style="color: #00538b;">arraySize</span> <span style="color: #5317ac;">=</span> <span style="color: #0000c0;">6</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #8f0075;">size_t</span> <span style="color: #00538b;">bufferSize</span> <span style="color: #5317ac;">=</span> arraySize <span style="color: #5317ac;">*</span> <span style="color: #5317ac;">sizeof</span><span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #8f0075;">int</span><span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Buffer</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">a</span> <span style="color: #5317ac;">=</span> device<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">newBuffer</span><span style="color: #a8007f; background-color: #ffffff;">(</span>bufferSize<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #005a5f;">MTL</span>::ResourceStorageModeShared<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Buffer</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">b</span> <span style="color: #5317ac;">=</span> device<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">newBuffer</span><span style="color: #a8007f; background-color: #ffffff;">(</span>bufferSize<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #005a5f;">MTL</span>::ResourceStorageModeShared<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Buffer</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">out</span> <span style="color: #5317ac;">=</span> device<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">newBuffer</span><span style="color: #a8007f; background-color: #ffffff;">(</span>bufferSize<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #005a5f;">MTL</span>::ResourceStorageModeShared<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #505050;">// copy data into buffers</span>
  <span style="color: #0000c0;">memcpy</span><span style="color: #a8007f; background-color: #ffffff;">(</span>a<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">contents</span><span style="color: #005f88; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">,</span> array1<span style="color: #000000; background-color: #ffffff;">,</span> bufferSize<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #0000c0;">memcpy</span><span style="color: #a8007f; background-color: #ffffff;">(</span>b<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">contents</span><span style="color: #005f88; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">,</span> array2<span style="color: #000000; background-color: #ffffff;">,</span> bufferSize<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #505050;">// pass argument data into the command encoder</span>
  command_encoder<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setBuffer</span><span style="color: #a8007f; background-color: #ffffff;">(</span>a<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">0</span><span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  command_encoder<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setBuffer</span><span style="color: #a8007f; background-color: #ffffff;">(</span>b<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  command_encoder<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setBuffer</span><span style="color: #a8007f; background-color: #ffffff;">(</span>out<span style="color: #000000; background-color: #ffffff;">,</span><span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">2</span><span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #505050;">// set thread count and organization, then run the damn thing</span>
  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Size</span> <span style="color: #00538b;">gridSize</span> <span style="color: #5317ac;">=</span> <span style="color: #005a5f;">MTL</span>::<span style="color: #0000c0;">Size</span><span style="color: #a8007f; background-color: #ffffff;">(</span>arraySize<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #005a5f;">NS</span>::<span style="color: #005a5f;">UInteger</span> <span style="color: #00538b;">threadsPerThreadgroup</span> <span style="color: #5317ac;">=</span> pso<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">maxTotalThreadsPerThreadgroup</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Size</span> <span style="color: #00538b;">threadgroupSize</span><span style="color: #a8007f; background-color: #ffffff;">(</span>threadsPerThreadgroup<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>

  command_encoder<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">dispatchThreads</span><span style="color: #a8007f; background-color: #ffffff;">(</span>gridSize<span style="color: #000000; background-color: #ffffff;">,</span> threadgroupSize<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  command_encoder<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">endEncoding</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>

  command_buffer<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">commit</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #505050;">// wait for the GPU work is done</span>
  command_buffer<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">waitUntilCompleted</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #505050;">// read results from buffer</span>
  <span style="color: #8f0075;">int</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">result</span> <span style="color: #5317ac;">=</span> <span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #8f0075;">int</span> <span style="color: #5317ac;">*</span><span style="color: #a8007f; background-color: #ffffff;">)</span>out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">contents</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #005a5f;">std</span>::cout <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #2544bb;">"results:"</span> <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #005a5f;">std</span>::endl<span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #5317ac;">for</span> <span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #8f0075;">size_t</span> <span style="color: #00538b;">i</span> <span style="color: #5317ac;">=</span> <span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">;</span> i <span style="color: #5317ac;">&lt;</span> arraySize<span style="color: #000000; background-color: #ffffff;">;</span> <span style="color: #5317ac;">++</span><span style="color: #00538b;">i</span><span style="color: #a8007f; background-color: #ffffff;">)</span> <span style="color: #a8007f; background-color: #ffffff;">{</span>
    <span style="color: #005a5f;">std</span>::cout <span style="color: #5317ac;">&lt;&lt;</span> result<span style="color: #005f88; background-color: #ffffff;">[</span>i<span style="color: #005f88; background-color: #ffffff;">]</span> <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #005a5f;">std</span>::endl<span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #a8007f; background-color: #ffffff;">}</span>

  a<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  b<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  pso<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  command_queue<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
  device<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>

  <span style="color: #5317ac;">return</span> <span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #000000; background-color: #ffffff;">}</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org0022cbf" class="outline-2">
<h2 id="org0022cbf"><span class="section-number-2">4.</span> Our shader code</h2>
<div class="outline-text-2" id="text-4">
<p>
Note: Apple has documentation on <a href="https://developer.apple.com/documentation/metal/performing_calculations_on_a_gpu?language=objc">metal</a>. You can even read the shading language reference <a href="https://developer.apple.com/metal/Metal-Shading-Language-Specification.pdf">here</a>.
Metal has a lot of similarities to C++14. Here is the add arrays function that we will create:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #005a5f;">kernel</span> void <span style="color: #721045;">add_arrays</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">device</span> <span style="color: #5317ac;">const</span> int <span style="color: #5317ac;">*</span> <span style="color: #00538b;">a</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #005a5f;">device</span> <span style="color: #5317ac;">const</span> int <span style="color: #5317ac;">*</span> <span style="color: #00538b;">b</span><span style="color: #000000; background-color: #ffffff;">,</span>
                       <span style="color: #005a5f;">device</span> int <span style="color: #5317ac;">*</span> <span style="color: #00538b;">result</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #005a5f;">uint</span> <span style="color: #00538b;">index</span> <span style="color: #a8007f; background-color: #ffffff;">[</span><span style="color: #005f88; background-color: #ffffff;">[</span>thread_position_in_grid<span style="color: #005f88; background-color: #ffffff;">]</span><span style="color: #a8007f; background-color: #ffffff;">]</span><span style="color: #000000; background-color: #ffffff;">)</span> <span style="color: #000000; background-color: #ffffff;">{</span>
  <span style="color: #00538b;">result</span><span style="color: #a8007f; background-color: #ffffff;">[</span>index<span style="color: #a8007f; background-color: #ffffff;">]</span> <span style="color: #5317ac;">=</span> a<span style="color: #a8007f; background-color: #ffffff;">[</span>index<span style="color: #a8007f; background-color: #ffffff;">]</span> <span style="color: #5317ac;">+</span> b<span style="color: #a8007f; background-color: #ffffff;">[</span>index<span style="color: #a8007f; background-color: #ffffff;">]</span><span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #000000; background-color: #ffffff;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org08df108" class="outline-2">
<h2 id="org08df108"><span class="section-number-2">5.</span> Running the project</h2>
<div class="outline-text-2" id="text-5">
<p>
I want to be able to decouple myself from XCode as far as possible. Hence why I used CMake.
Here is how my project is structured at the moment:
</p>
<pre class="example">
.
├── CMakeLists.txt
├── build
│   ├── CMakeCache.txt
│   ├── CMakeFiles
│   │   └── ...
│   ├── Makefile
│   ├── buildshader.sh
│   ├── cmake_install.cmake
│   ├── compute_sumarrays
│   └── shader.metallib
├── lib
│   └── metal-cpp
│       └── ...
├── metalapi.html
├── metalapi.org
└── src
    ├── main.cc
    ├── shader.metal
    └── shader.metallib

</pre>
</div>

<div id="outline-container-org423934f" class="outline-3">
<h3 id="org423934f"><span class="section-number-3">5.1.</span> Compiling Your Metal Library</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Since we are not using XCode, we cannot use <code>device-&gt;getDefaultLibrary()</code> to magically compile and import our metal shaders.
Hence, as hinted in the source code, we will have to compile our shaders into a metal library to import.
</p>

<p>
You will need XCode Command Line Tools. See documentation <a href="https://developer.apple.com/documentation/metal/shader_libraries/compiling_shader_code_into_a_library_with_metal_s_command-line_tools?language=objc">here</a> for full instructions on how to compile shader code.
</p>

<p>
Here is a TLDR: <br />
</p>
<ol class="org-ol">
<li>Go to the directory with your <code>shader.metal</code> file.</li>
<li><p>
Run the following:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #0000c0;">xcrun</span> <span style="color: #0000c0;">-sdk</span> macosx metal <span style="color: #0000c0;">-c</span> shader.metal <span style="color: #0000c0;">-o</span> shader.air
<span style="color: #0000c0;">xcrun</span> <span style="color: #0000c0;">-sdk</span> macosx metallib shader.air <span style="color: #0000c0;">-o</span> shader.metallib
</pre>
</div></li>
<li>copy the shader.metallib file to your <code>build</code> directory.</li>
</ol>
</div>
</div>

<div id="outline-container-orga7e342a" class="outline-3">
<h3 id="orga7e342a"><span class="section-number-3">5.2.</span> Running your code</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Next, you will need to run <code>make</code> in your build directory. It will produce an executable.
Then, run your program.
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000c0;">./compute_sumarrays</span>
</pre>
</div>

<p>
<b>Output</b>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">results:</td>
</tr>

<tr>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">7</td>
</tr>
</tbody>
</table>

<p>
Note: Every single time you change your source code, you will need to run <code>make</code> again.
</p>
</div>
</div>
</div>

<div id="outline-container-org0bc296a" class="outline-2">
<h2 id="org0bc296a"><span class="section-number-2">6.</span> Next Steps</h2>
<div class="outline-text-2" id="text-6">
<p>
It took me a very long time to get my project to compile, but its all worth it because I can
do all of this without using an XCode project.
</p>

<p>
Now that I can add two arrays using metal, let's try rewriting my ray tracer using metal.
</p>
</div>
</div>

<div id="outline-container-orgfb411b7" class="outline-2">
<h2 id="orgfb411b7"><span class="section-number-2">7.</span> Addendum</h2>
<div class="outline-text-2" id="text-7">
<p>
After encountering several problems, I have realised that turning my ray tracer into metal
shader code is not as easy as initially thought. Here are some ranodm things I have learned
so that my week of pain does not have to occur again:
</p>
</div>

<div id="outline-container-org1d5dfb4" class="outline-3">
<h3 id="org1d5dfb4"><span class="section-number-3">7.1.</span> Simd</h3>
<div class="outline-text-3" id="text-7-1">
<p>
simd allows me to define vector types (like float3) that can be understood by the GPU as
well. Thus, my C++ code and metal code can share custom classes by defining the
class in a header file and leaving the implementation in metal (I think? As long as
the constructor is defined in the header I dont see why not)
</p>
</div>
</div>

<div id="outline-container-orgb194499" class="outline-3">
<h3 id="orgb194499"><span class="section-number-3">7.2.</span> Compiling multiple metal files</h3>
<div class="outline-text-3" id="text-7-2">
<p>
To create a single file metal lib file at the end, you will need to compile all your
metal files into .air files (you do not need to worry about the header files). Then,
run
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000c0;">xcrun</span> <span style="color: #0000c0;">-sdk</span> macosx metal-ar rcs <span style="color: #5317ac;">&lt;</span>archive name<span style="color: #5317ac;">&gt;</span> *.air
</pre>
</div>

<p>
This should put all of your files into a single archive. You can then run <code>metallib</code> on
that archive file.
</p>
</div>
</div>

<div id="outline-container-org232b6db" class="outline-3">
<h3 id="org232b6db"><span class="section-number-3">7.3.</span> Randomness</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Turns out, there is no random generator included in metal. So, if I need to generate a random
number in my shader, I will have to include a custom library.
Credits to this forum: <a href="https://developer.apple.com/forums/thread/26454">Apple Form</a> <br />
</p>

<p>
If I need to seed my RNG, I can pass in a noise texture from my main code to the shaders. I haven't
tested if this is necessary though
</p>
</div>
</div>

<div id="outline-container-orga71149c" class="outline-3">
<h3 id="orga71149c"><span class="section-number-3">7.4.</span> Writing to a 2D Output Buffer</h3>
<div class="outline-text-3" id="text-7-4">
<p>
All the buffers I've worked with are 1D. How do I take my 2D array of float3's
and write to them in metal?
</p>
</div>

<div id="outline-container-orga5e0bf8" class="outline-4">
<h4 id="orga5e0bf8"><span class="section-number-4">7.4.1.</span> Textures</h4>
<div class="outline-text-4" id="text-7-4-1">
<p>
So you need a texture. To initialize a texture:
</p>
</div>
<ol class="org-ol">
<li><a id="org598b974"></a>Building a Texture Descriptor<br />
<div class="outline-text-5" id="text-7-4-1-1">
<p>
In a descriptor, you will need to set the
width, height, pixel format, texture type, storage mode, and usage.
Example:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">TextureDescriptor</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">desc</span> <span style="color: #5317ac;">=</span> <span style="color: #005a5f;">MTL</span>::<span style="color: #0000c0;">TextureDescriptor</span><span style="color: #0000c0;">::alloc</span><span style="color: #000000; background-color: #ffffff;">()</span><span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">init</span><span style="color: #000000; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
desc<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setWidth</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #0000c0;">800</span><span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
desc<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setHeight</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #0000c0;">600</span><span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
desc<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setPixelFormat</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">MTL</span>::PixelFormatRGBA8Unorm<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
desc<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setTextureType</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">MTL</span>::TextureType2D<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
desc<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setStorageMode</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">MTL</span>::StorageModeManaged<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
desc<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setUsage</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">MTL</span>::ResourceUsageRead <span style="color: #5317ac;">|</span> <span style="color: #005a5f;">MTL</span>::ResourceUsageWrite<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
</pre>
</div>

<p>
Here is the documentation for MTL::TextureDescriptor: <a href="https://developer.apple.com/documentation/metal/mtltexturedescriptor?language=objc">apol dot com</a>
</p>

<p>
TLDR:
</p>
<ul class="org-ul">
<li>width and height are self-explanatory</li>
<li>you can also set depth, for layers I guess?</li>
<li>pixel format determines how many channels (R, RG, RGBA) and how many bits per channel (8, 16), as well
as the data type of each component. UNorm means that floats in the range [0, 1] are stored as
an unsigned integer from 0 to UINT<sub>MAX</sub>. <br />
In the case of RGBA8Unorm, each component is 8 bits, ranging from 0 to \(255\).</li>
<li>texture type describes the way the data is arranged, (1D, 2D, etc&#x2026;)</li>
<li>Storage Mode determines where and who has the resources. MTLStorageModeShared stores
the resource in system memory and can be accessed by both CPU and GPU.
Managed requires you to manually synchronize the changes.</li>
<li>Usage enables reading or writing to the resource in a shader.</li>
</ul>
</div>
</li>

<li><a id="orga8c8984"></a>Creating a texture<br />
<div class="outline-text-5" id="text-7-4-1-2">
<p>
You call <code>device-&gt;newTexture(desc)</code> and save it as a texture pointer:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Texture</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">myTexture</span> <span style="color: #5317ac;">=</span> device<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">newTexture</span><span style="color: #000000; background-color: #ffffff;">(</span>desc<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
desc<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">release</span><span style="color: #000000; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
</pre>
</div>

<p>
You can free the description after creating the new texture.
</p>
</div>
</li>

<li><a id="orgcd85e9b"></a>Passing the texture as an argument<br />
<div class="outline-text-5" id="text-7-4-1-3">
<p>
To pass a buffer into the function, you would do the following:
</p>
<div class="org-src-container">
<pre class="src src-C++">command_encoder<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setBuffer</span><span style="color: #000000; background-color: #ffffff;">(</span>myBuffer<span style="color: #000000; background-color: #ffffff;">,</span> offset<span style="color: #000000; background-color: #ffffff;">,</span> index<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
</pre>
</div>

<p>
where offset tells you where the data begins from the start of the buffer (in bytes), and
index is the index in the buffer argument table. This is not always
correlated to the index of the argument passed into the function.
</p>

<p>
You do a similar thing with textures:
</p>
<div class="org-src-container">
<pre class="src src-C++">command_encoder<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">setTexture</span><span style="color: #000000; background-color: #ffffff;">(</span>myTexture<span style="color: #000000; background-color: #ffffff;">,</span> index<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
</pre>
</div>

<p>
The difference is that you are passing in a texture and the index determines the index
in the <b>texture</b> argument table.
</p>
</div>
</li>

<li><a id="orgdd03d09"></a>Finishing up Pipeline setup<br />
<div class="outline-text-5" id="text-7-4-1-4">
<p>
You need to decide how you want to dispatch the threads.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Size</span> <span style="color: #00538b;">gridSize</span> <span style="color: #5317ac;">=</span> <span style="color: #005a5f;">MTL</span>::<span style="color: #0000c0;">Size</span><span style="color: #000000; background-color: #ffffff;">(</span>textureWidth<span style="color: #000000; background-color: #ffffff;">,</span> textureHeight<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #005a5f;">NS</span>::<span style="color: #005a5f;">UInteger</span> <span style="color: #00538b;">maxThreads</span> <span style="color: #5317ac;">=</span> pso<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">maxTotalThreadsPerThreadgroup</span><span style="color: #000000; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Size</span> <span style="color: #00538b;">threadgroupSize</span> <span style="color: #5317ac;">=</span> <span style="color: #005a5f;">MTL</span>::<span style="color: #0000c0;">Size</span><span style="color: #000000; background-color: #ffffff;">(</span>maxThreads<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">1</span><span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
</pre>
</div>
</div>
</li>

<li><a id="org87cecb5"></a>Your Shader<br />
<div class="outline-text-5" id="text-7-4-1-5">
<p>
Let's do an example of a shader that takes a matrix and an array and performs some
calculation on it.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #a0132f;">#include</span> <span style="color: #2544bb;">&lt;metal_stdlib&gt;</span>
<span style="color: #5317ac;">using</span> <span style="color: #5317ac;">namespace</span> metal<span style="color: #000000; background-color: #ffffff;">;</span>

<span style="color: #005a5f;">kernel</span> void <span style="color: #721045;">shader</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">texture2d</span><span style="color: #5317ac;">&lt;</span><span style="color: #8f0075;">float</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #005a5f;">access</span>:write<span style="color: #5317ac;">&gt;</span> <span style="color: #00538b;">tex</span> <span style="color: #a8007f;">[</span><span style="color: #005f88;">[</span>texture<span style="color: #904200; background-color: #ffffff;">(</span><span style="color: #0000c0;">0</span><span style="color: #904200; background-color: #ffffff;">)</span><span style="color: #005f88;">]</span><span style="color: #a8007f;">]</span><span style="color: #000000; background-color: #ffffff;">,</span>
                   <span style="color: #005a5f;">uint2</span> <span style="color: #00538b;">index</span> <span style="color: #a8007f;">[</span><span style="color: #005f88;">[</span>thread_position_in_grid<span style="color: #005f88;">]</span><span style="color: #a8007f;">]</span><span style="color: #000000; background-color: #ffffff;">)</span> <span style="color: #000000; background-color: #ffffff;">{</span>
  <span style="color: #005a5f;">mt19937</span> <span style="color: #00538b;">mt</span><span style="color: #000000; background-color: #ffffff;">;</span>
  mt<span style="color: #000000; background-color: #ffffff;">.</span><span style="color: #0000c0; font-style: italic;">srand</span><span style="color: #a8007f; background-color: #ffffff;">(</span>index<span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
  tex<span style="color: #000000; background-color: #ffffff;">.</span><span style="color: #0000c0; font-style: italic;">write</span><span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #0000c0;">float3</span><span style="color: #005f88; background-color: #ffffff;">(</span>mt<span style="color: #000000; background-color: #ffffff;">.</span><span style="color: #0000c0; font-style: italic;">rand</span><span style="color: #904200; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">,</span> mt<span style="color: #000000; background-color: #ffffff;">.</span><span style="color: #0000c0; font-style: italic;">rand</span><span style="color: #904200; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">,</span> mt<span style="color: #000000; background-color: #ffffff;">.</span><span style="color: #0000c0; font-style: italic;">rand</span><span style="color: #904200; background-color: #ffffff;">()</span><span style="color: #005f88; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">,</span> index<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">0</span><span style="color: #a8007f; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #000000; background-color: #ffffff;">}</span>
</pre>
</div>
</div>
</li>

<li><a id="org1fafcdc"></a>Reading the result<br />
<div class="outline-text-5" id="text-7-4-1-6">
<p>
Next, the result needs to be read. This can be done using the <code>getBytes()</code> function.
We will need to pass in four parameters:
</p>
<ul class="org-ul">
<li>A pointer to write to: Make sure you have allocated space for the data to be written to!</li>
<li>Number of bytes per row: In this case, it's 4 8-bit components (RGBA) per pixel multiplied by the
width of the texture</li>
<li>Destination region is just the region of pixels in the texture</li>
<li>Mipmap level is zero in our case.</li>
</ul>

<p>
Example:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #8f0075;">int</span> <span style="color: #00538b;">bytesPerRow</span> <span style="color: #5317ac;">=</span> out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">width</span><span style="color: #000000; background-color: #ffffff;">()</span> <span style="color: #5317ac;">*</span> <span style="color: #5317ac;">sizeof</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">simd</span>::<span style="color: #005a5f;">uchar4</span><span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #8f0075;">int</span> <span style="color: #00538b;">bytesPerImage</span> <span style="color: #5317ac;">=</span> out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">height</span><span style="color: #000000; background-color: #ffffff;">()</span> <span style="color: #5317ac;">*</span> bytesPerRow<span style="color: #000000; background-color: #ffffff;">;</span>

<span style="color: #005a5f;">MTL</span>::<span style="color: #005a5f;">Region</span> <span style="color: #00538b;">destinationRegion</span> <span style="color: #5317ac;">=</span> <span style="color: #005a5f;">MTL</span>::<span style="color: #0000c0;">Region</span><span style="color: #0000c0;">::Make2D</span><span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">,</span> out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">width</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">,</span> out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">height</span><span style="color: #a8007f; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #005a5f;">simd</span>::<span style="color: #005a5f;">uchar4</span> <span style="color: #5317ac;">*</span> <span style="color: #00538b;">pixelBytes</span> <span style="color: #5317ac;">=</span> <span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #005a5f;">simd</span>::<span style="color: #005a5f;">uchar4</span> <span style="color: #5317ac;">*</span><span style="color: #000000; background-color: #ffffff;">)</span> <span style="color: #0000c0;">malloc</span><span style="color: #000000; background-color: #ffffff;">(</span>bytesPerImage<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">getBytes</span><span style="color: #000000; background-color: #ffffff;">(</span>pixelBytes<span style="color: #000000; background-color: #ffffff;">,</span> bytesPerRow<span style="color: #000000; background-color: #ffffff;">,</span> destinationRegion<span style="color: #000000; background-color: #ffffff;">,</span> <span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>

<span style="color: #8f0075;">int</span> <span style="color: #00538b;">length</span> <span style="color: #5317ac;">=</span> out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">width</span><span style="color: #000000; background-color: #ffffff;">()</span> <span style="color: #5317ac;">*</span> out<span style="color: #5317ac;">-&gt;</span><span style="color: #0000c0; font-style: italic;">height</span><span style="color: #000000; background-color: #ffffff;">()</span><span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #005a5f;">std</span>::cout <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #2544bb;">"results:"</span> <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #005a5f;">std</span>::endl<span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #5317ac;">for</span> <span style="color: #000000; background-color: #ffffff;">(</span><span style="color: #8f0075;">size_t</span> <span style="color: #00538b;">i</span> <span style="color: #5317ac;">=</span> <span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">;</span> i <span style="color: #5317ac;">&lt;</span> length<span style="color: #000000; background-color: #ffffff;">;</span> <span style="color: #5317ac;">++</span><span style="color: #00538b;">i</span><span style="color: #000000; background-color: #ffffff;">)</span> <span style="color: #000000; background-color: #ffffff;">{</span>
  <span style="color: #5317ac;">for</span> <span style="color: #a8007f; background-color: #ffffff;">(</span><span style="color: #8f0075;">size_t</span> <span style="color: #00538b;">j</span> <span style="color: #5317ac;">=</span> <span style="color: #0000c0;">0</span><span style="color: #000000; background-color: #ffffff;">;</span> j <span style="color: #5317ac;">&lt;</span> <span style="color: #0000c0;">4</span><span style="color: #000000; background-color: #ffffff;">;</span> <span style="color: #5317ac;">++</span><span style="color: #00538b;">j</span><span style="color: #a8007f; background-color: #ffffff;">)</span> <span style="color: #a8007f; background-color: #ffffff;">{</span>
    <span style="color: #005a5f;">std</span>::cout <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #005f88; background-color: #ffffff;">(</span><span style="color: #8f0075;">float</span><span style="color: #005f88; background-color: #ffffff;">)</span>pixelBytes<span style="color: #005f88; background-color: #ffffff;">[</span>i<span style="color: #005f88; background-color: #ffffff;">][</span>j<span style="color: #005f88; background-color: #ffffff;">]</span><span style="color: #5317ac;">/</span> <span style="color: #0000c0;">UCHAR_MAX</span>  <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #2544bb;">" "</span><span style="color: #000000; background-color: #ffffff;">;</span>
  <span style="color: #a8007f; background-color: #ffffff;">}</span>
  <span style="color: #005a5f;">std</span>::cout <span style="color: #5317ac;">&lt;&lt;</span> <span style="color: #005a5f;">std</span>::endl<span style="color: #000000; background-color: #ffffff;">;</span>
<span style="color: #000000; background-color: #ffffff;">}</span>

<span style="color: #0000c0;">free</span><span style="color: #000000; background-color: #ffffff;">(</span>pixelBytes<span style="color: #000000; background-color: #ffffff;">)</span><span style="color: #000000; background-color: #ffffff;">;</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</body>
</html>
