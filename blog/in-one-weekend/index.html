<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-01-10 Wed 21:35 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ray Tracing</title>
<meta name="author" content="Sean Zhang" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="/org.css"/>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Ray Tracing
<br />
<span class="subtitle">Notes on <i>Ray Tracing in One Weekend</i></span>
</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org885eb43">1. Output An Image</a>
<ul>
<li><a href="#org88a7c50">1.1. PPM Image Format</a>
<ul>
<li><a href="#orgd6901cc">1.1.1. Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org4bb6443">2. Vec3 Class</a>
<ul>
<li><a href="#orgaf88705">2.1. Vec3.h</a></li>
<li><a href="#orgba3f591">2.2. color.h</a></li>
<li><a href="#orge9fe49d">2.3. Revisiting Example 1.1.1</a></li>
</ul>
</li>
<li><a href="#orgd470616">3. Rays</a>
<ul>
<li><a href="#org8468359">3.1. Ray Class</a></li>
<li><a href="#org0d0c140">3.2. Sending Rays into Scene</a></li>
<li><a href="#org4790889">3.3. Example: Rendering a blue-to-white gradient, using Ray Tracing</a></li>
</ul>
</li>
<li><a href="#orgcc6b3c6">4. Adding a sphere to the scene</a>
<ul>
<li><a href="#orgfe2aadb">4.1. Hit detection</a>
<ul>
<li><a href="#orga78123f">4.1.1. Expressing as vectors</a></li>
<li><a href="#org2e118c1">4.1.2. Detecting if rays hit sphere</a></li>
<li><a href="#orge22160d">4.1.3. Example: Adding the shape to our gradient</a></li>
</ul>
</li>
<li><a href="#org3bf923b">4.2. Surface Normals</a>
<ul>
<li><a href="#orge75f2ac">4.2.1. Example: Visualizing The Normal</a></li>
</ul>
</li>
<li><a href="#org3bfdd0a">4.3. Simplifying the intersection code.</a></li>
<li><a href="#orgee3de0f">4.4. Abstraction to hittable objects</a>
<ul>
<li><a href="#org3aba30b">4.4.1. Front Faces vs Back Faces</a></li>
<li><a href="#orgfa6c9f8">4.4.2. A List of Hittable Objects</a></li>
<li><a href="#org7689bf9">4.4.3. Wrapping Up With a Revised Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5123707">5. Antialiasing</a>
<ul>
<li><a href="#org0152494">5.1. Random Number Generation</a></li>
<li><a href="#org6fbe4b8">5.2. Abstracting the Camera</a></li>
</ul>
</li>
<li><a href="#org9310e5f">6. Diffuse Materials</a>
<ul>
<li><a href="#org371fd54">6.1. Simple diffuse material</a></li>
<li><a href="#orge0f0646">6.2. Using Gamma Correction for Accurate Color Intensity</a></li>
<li><a href="#orgcc540e8">6.3. Shadow Acne</a></li>
<li><a href="#org7de5f43">6.4. True Lambertian Reflection</a></li>
<li><a href="#org5b369e1">6.5. Another Diffuse Formulation</a></li>
</ul>
</li>
<li><a href="#org39602b2">7. Metal</a>
<ul>
<li><a href="#orgdcb6b8e">7.1. Abstracting materials</a></li>
<li><a href="#org8c8ec6b">7.2. Modelling light scatter and reflectance</a>
<ul>
<li><a href="#org02a1198">7.2.1. Lambertian Material</a></li>
<li><a href="#org33a756f">7.2.2. Metal Material</a></li>
</ul>
</li>
<li><a href="#orge69a96c">7.3. A scene with metal spheres</a></li>
<li><a href="#org1f75ddb">7.4. Fuzzy Reflections</a></li>
</ul>
</li>
<li><a href="#org39111fd">8. Dielectrics</a>
<ul>
<li><a href="#org21d2dff">8.1. Refraction</a></li>
<li><a href="#orge7c38f2">8.2. Total Internal reflection</a></li>
<li><a href="#org34814fb">8.3. Schlick approximation</a></li>
<li><a href="#orgf87da5f">8.4. Hollow Glass Sphere</a></li>
</ul>
</li>
<li><a href="#orgb9292f8">9. Positionable Camera</a>
<ul>
<li><a href="#orgcaaa401">9.1. Camera Viewing Geometry</a></li>
<li><a href="#org4abfd9e">9.2. Positioning of Camera</a></li>
</ul>
</li>
<li><a href="#orgc94f8a0">10. Depth of Field (Defocus Blur)</a>
<ul>
<li><a href="#org2a2be46">10.1. Thin lens approximation</a></li>
<li><a href="#orgf9358db">10.2. Generating sample rays</a></li>
</ul>
</li>
<li><a href="#orga917042">11. The Finale</a></li>
<li><a href="#orgc0f50c8">12. Multithreading</a>
<ul>
<li><a href="#org6af9e8c">12.1. Potential Improvements</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org885eb43" class="outline-2">
<h2 id="org885eb43"><span class="section-number-2">1.</span> Output An Image</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org88a7c50" class="outline-3">
<h3 id="org88a7c50"><span class="section-number-3">1.1.</span> PPM Image Format</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Usually it details some sort of encoding - <code>P3</code> being colors in ASCII.
Then new line followed by <code>Num Cols</code> space, <code>Num Rows</code>.
The next line is a single number detailing the scale (<code>255</code> usually denotes max color).
Then <code>R G B</code> space separated values times the number of columns per row.
Then you have <code>Num Rows</code> rows to get you the final image.
</p>
</div>
<div id="outline-container-orgd6901cc" class="outline-4">
<h4 id="orgd6901cc"><span class="section-number-4">1.1.1.</span> Example</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
<b>Source:</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org19f0166"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
  <span style="color: #51afef;">using</span> <span style="color: #51afef;">namespace</span> <span style="color: #a9a1e1;">std</span>;

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
      <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">image_width</span> = <span style="color: #da8548; font-weight: bold;">256</span>;
      <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">image_height</span> = <span style="color: #da8548; font-weight: bold;">256</span>;

      cout &lt;&lt; <span style="color: #98be65;">"P3"</span> &lt;&lt; endl &lt;&lt; image_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; image_height &lt;&lt; endl
                &lt;&lt; <span style="color: #98be65;">"255"</span> &lt;&lt; endl;

      <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span> = image_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
          <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; image_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
               <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">r</span> = <span style="color: #ECBE7B;">double</span><span style="color: #a9a1e1;">(</span>i<span style="color: #a9a1e1;">)</span> / <span style="color: #a9a1e1;">(</span>image_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
               <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">g</span> = <span style="color: #ECBE7B;">double</span><span style="color: #a9a1e1;">(</span>j<span style="color: #a9a1e1;">)</span> / <span style="color: #a9a1e1;">(</span>image_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
               <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">b</span> = <span style="color: #da8548; font-weight: bold;">0.25</span>;

               <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">ir</span> = <span style="color: #51afef;">static_cast</span><span style="color: #a9a1e1;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #a9a1e1;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * r<span style="color: #a9a1e1;">)</span>;
               <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">ig</span> = <span style="color: #51afef;">static_cast</span><span style="color: #a9a1e1;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #a9a1e1;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * g<span style="color: #a9a1e1;">)</span>;
               <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">ib</span> = <span style="color: #51afef;">static_cast</span><span style="color: #a9a1e1;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #a9a1e1;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * b<span style="color: #a9a1e1;">)</span>;

               <span style="color: #5B6268;">// </span><span style="color: #5B6268;">for each pixel</span>
               cout &lt;&lt; ir &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; ig &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; ib &lt;&lt; endl;
          <span style="color: #98be65;">}</span>
      <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output:</b>
</p>

<div id="org1c53ed4" class="figure">
<p><img src="./images/gradient.png" alt="gradient.png" />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org4bb6443" class="outline-2">
<h2 id="org4bb6443"><span class="section-number-2">2.</span> Vec3 Class</h2>
<div class="outline-text-2" id="text-2">
<p>
A 3D vector class that&rsquo;s used for:
</p>
<ul class="org-ul">
<li>Colors</li>
<li>Locations</li>
<li>Directions</li>
<li>Offsets</li>
<li>etc.</li>
</ul>
<p>
There will be two aliases created for vec3: point3 and color.
This is just used to clarify intent and use.
</p>
</div>
<div id="outline-container-orgaf88705" class="outline-3">
<h3 id="orgaf88705"><span class="section-number-3">2.1.</span> Vec3.h</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<b>Code for Vec3: <code>vec3.h</code></b>
</p>

<p>
Note: This is just for showing. The code is stored as a file <a href="./util/vec3.h">here</a>.
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org56013fb"><span style="color: #51afef; font-weight: bold;">      #if</span><span style="color: #51afef; font-weight: bold;">n</span><span style="color: #51afef; font-weight: bold;">def</span> VEC3_H
<span style="color: #51afef; font-weight: bold;">      #define</span> <span style="color: #dcaeea;">VEC3_H</span>

<span style="color: #51afef; font-weight: bold;">      #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

      <span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">{</span>
          <span style="color: #51afef;">public</span>:
               <span style="color: #c678dd;">vec3</span><span style="color: #c678dd;">()</span> : e<span style="color: #c678dd;">{</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">}</span> <span style="color: #c678dd;">{}</span>
               <span style="color: #c678dd;">vec3</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">e0</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">e1</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">e2</span><span style="color: #c678dd;">)</span> : e<span style="color: #c678dd;">{</span>e0, e1, e2<span style="color: #c678dd;">}</span> <span style="color: #c678dd;">{}</span>
               <span style="color: #5B6268;">// </span><span style="color: #5B6268;">getter methods</span>
               <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">x</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span><span style="color: #51afef;">return</span> e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">}</span>
               <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">y</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span><span style="color: #51afef;">return</span> e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">}</span>
               <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">z</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span><span style="color: #51afef;">return</span> e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">}</span>

               <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">-</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span> <span style="color: #51afef;">return</span> vec3<span style="color: #98be65;">(</span>-e<span style="color: #a9a1e1;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">]</span>, -e<span style="color: #a9a1e1;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">]</span>, -e<span style="color: #a9a1e1;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #a9a1e1;">]</span><span style="color: #98be65;">)</span>; <span style="color: #c678dd;">}</span>
               <span style="color: #ECBE7B;">double</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">[]</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span><span style="color: #51afef;">return</span> e<span style="color: #98be65;">[</span>i<span style="color: #98be65;">]</span>; <span style="color: #c678dd;">}</span>
               <span style="color: #ECBE7B;">double</span>&amp; <span style="color: #51afef;">operator</span><span style="color: #c678dd;">[]</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span><span style="color: #51afef;">return</span> e<span style="color: #98be65;">[</span>i<span style="color: #98be65;">]</span>; <span style="color: #c678dd;">}</span>

               <span style="color: #5B6268;">// </span><span style="color: #5B6268;">adding</span>
               <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">+=</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
                   <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; <span style="color: #da8548; font-weight: bold;">3</span>; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
                       e<span style="color: #a9a1e1;">[</span>i<span style="color: #a9a1e1;">]</span> += v.e<span style="color: #a9a1e1;">[</span>i<span style="color: #a9a1e1;">]</span>;
                   <span style="color: #98be65;">}</span>
                   <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span>;
               <span style="color: #c678dd;">}</span>
               <span style="color: #5B6268;">// </span><span style="color: #5B6268;">scalar multiplication</span>
               <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #51afef;">operator</span><span style="color: #c678dd;">*=</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
                   <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; <span style="color: #da8548; font-weight: bold;">3</span>; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
                       e<span style="color: #a9a1e1;">[</span>i<span style="color: #a9a1e1;">]</span> *= t;
                   <span style="color: #98be65;">}</span>
                   <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span>;
               <span style="color: #c678dd;">}</span>

               <span style="color: #5B6268;">// </span><span style="color: #5B6268;">scalar division</span>
               <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #51afef;">operator</span><span style="color: #c678dd;">/=</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
                   <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span> *= <span style="color: #da8548; font-weight: bold;">1</span>/t;
               <span style="color: #c678dd;">}</span>

               <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">length</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span>
                   <span style="color: #5B6268;">// </span><span style="color: #5B6268;">return std::sqrt(length_squared());</span>
                   <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">1.0</span>;
               <span style="color: #c678dd;">}</span>

               <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">length_squared</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span>
                   <span style="color: #51afef;">return</span> e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span>*e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span> + e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span>*e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span> + e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span>*e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span>;
               <span style="color: #c678dd;">}</span>
           <span style="color: #51afef;">public</span>:
               <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">e</span><span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">3</span><span style="color: #c678dd;">]</span>;
      <span style="color: #51afef;">}</span>;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Type aliases for vec3</span>
    <span style="color: #51afef;">using</span> <span style="color: #ECBE7B;">point3</span> = vec3; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">used for 3D points</span>
    <span style="color: #51afef;">using</span> <span style="color: #ECBE7B;">color</span> = vec3;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">used for RGB color</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">vec3 Utility Functions</span>

    <span style="color: #51afef;">inline</span> <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">ostream</span>&amp; <span style="color: #51afef;">operator</span><span style="color: #c678dd;">&lt;&lt;</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">ostream</span> &amp;<span style="color: #dcaeea;">out</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> out &lt;&lt; v.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">]</span> &lt;&lt; <span style="color: #98be65;">' '</span> &lt;&lt; v.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">]</span> &lt;&lt; <span style="color: #98be65;">' '</span> &lt;&lt; v.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">]</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">+</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">u</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> vec3<span style="color: #c678dd;">(</span>u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span> + v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span>, u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span> + v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span>, u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span> + v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">-</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">u</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> vec3<span style="color: #c678dd;">(</span>u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span> - v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span>, u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span> - v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span>, u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span> - v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">*</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">u</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> vec3<span style="color: #c678dd;">(</span>u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span>, u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span>, u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">*</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> vec3<span style="color: #c678dd;">(</span>t*v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span>, t*v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span>, t*v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">*</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> t * v;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">/</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">v</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>/t<span style="color: #c678dd;">)</span> * v;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">dot</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">u</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> u.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">]</span> * v.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">]</span>
             + u.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">]</span> * v.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">]</span>
             + u.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">]</span> * v.e<span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">]</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">cross</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">u</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span> &amp;<span style="color: #dcaeea;">v</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> vec3<span style="color: #c678dd;">(</span>u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span> - u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span>,
                    u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span> - u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">]</span>,
                    u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span> - u.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">]</span> * v.e<span style="color: #98be65;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">unit_vector</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">v</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> v / v.length<span style="color: #c678dd;">()</span>;
    <span style="color: #51afef;">}</span>
<span style="color: #51afef; font-weight: bold;">      #endif</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgba3f591" class="outline-3">
<h3 id="orgba3f591"><span class="section-number-3">2.2.</span> color.h</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<b>Code for Color Utility: <code>color.h</code></b>
</p>

<p>
Saved as a header <a href="./util/color.h">here</a>.
</p>
<div class="org-src-container">
<pre class="src src-C++" id="orgcf80900"><span style="color: #51afef; font-weight: bold;">  #if</span><span style="color: #51afef; font-weight: bold;">n</span><span style="color: #51afef; font-weight: bold;">def</span> <span style="color: #a9a1e1;">COLOR_H</span>
<span style="color: #51afef; font-weight: bold;">  #define</span> <span style="color: #dcaeea;">COLOR_H</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"vec3.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">write_color</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">ostream</span> &amp;<span style="color: #dcaeea;">out</span>, <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">pixel_color</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Write the translated [0,255] value of each color component.</span>
    out &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * pixel_color.x<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">' '</span>
        &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * pixel_color.y<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">' '</span>
        &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * pixel_color.z<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">'\n'</span>;
  <span style="color: #51afef;">}</span>

<span style="color: #51afef; font-weight: bold;">  #endif</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge9fe49d" class="outline-3">
<h3 id="orge9fe49d"><span class="section-number-3">2.3.</span> Revisiting Example 1.1.1</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Update the old example but this time using the color class and using <code>write_color</code>. I also added
more blue hue to all the pixels.
</p>

<p>
<b>Source:</b> 
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org7143f4d"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/vec3.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #51afef;">using</span> <span style="color: #51afef;">namespace</span> <span style="color: #a9a1e1;">std</span>;

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
      <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">image_width</span> = <span style="color: #da8548; font-weight: bold;">256</span>;
      <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">image_height</span> = <span style="color: #da8548; font-weight: bold;">256</span>;

      cout &lt;&lt; <span style="color: #98be65;">"P3"</span> &lt;&lt; endl &lt;&lt; image_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; image_height &lt;&lt; endl
                &lt;&lt; <span style="color: #98be65;">"255"</span> &lt;&lt; endl;

      <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span> = image_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
          <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; image_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
               <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">pixel</span><span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">double</span><span style="color: #51afef;">(</span>i<span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>image_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>,
                           <span style="color: #ECBE7B;">double</span><span style="color: #51afef;">(</span>j<span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>image_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>, <span style="color: #da8548; font-weight: bold;">0.85</span><span style="color: #a9a1e1;">)</span>;
               write_color<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, pixel<span style="color: #a9a1e1;">)</span>;
          <span style="color: #98be65;">}</span>
      <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output:</b>
</p>

<div id="org9299534" class="figure">
<p><img src="./images/gradient-mod.png" alt="gradient-mod.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd470616" class="outline-2">
<h2 id="orgd470616"><span class="section-number-2">3.</span> Rays</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org8468359" class="outline-3">
<h3 id="org8468359"><span class="section-number-3">3.1.</span> Ray Class</h3>
<div class="outline-text-3" id="text-3-1">
<p>
A ray is a function, \(P(t) = A + tb\), \(t \in \mathbb{R}\). A is the ray origin, and b is the ray vector.
</p>

<div class="org-src-container">
<pre class="src src-C++"><span style="color: #51afef; font-weight: bold;">#if</span><span style="color: #51afef; font-weight: bold;">n</span><span style="color: #51afef; font-weight: bold;">def</span> <span style="color: #a9a1e1;">RAY_H</span>
<span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">RAY_H</span>

<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">"vec3.h"</span>

<span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">ray</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">public</span>:
        <span style="color: #c678dd;">ray</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{}</span>
        <span style="color: #c678dd;">ray</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">point3</span>&amp; <span style="color: #dcaeea;">origin</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #dcaeea;">direction</span><span style="color: #c678dd;">)</span>
            : orig<span style="color: #c678dd;">(</span>origin<span style="color: #c678dd;">)</span>, dir<span style="color: #c678dd;">(</span>direction<span style="color: #c678dd;">)</span>
        <span style="color: #c678dd;">{}</span>

        <span style="color: #ECBE7B;">point3</span> <span style="color: #c678dd;">origin</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span>  <span style="color: #c678dd;">{</span> <span style="color: #51afef;">return</span> orig; <span style="color: #c678dd;">}</span>
        <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">direction</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span> <span style="color: #51afef;">return</span> dir; <span style="color: #c678dd;">}</span>

        <span style="color: #ECBE7B;">point3</span> <span style="color: #c678dd;">at</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span>
            <span style="color: #51afef;">return</span> orig + t*dir;
        <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">public</span>:
        <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">orig</span>;
        <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">dir</span>;
<span style="color: #51afef;">}</span>;

<span style="color: #51afef; font-weight: bold;">#endif</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org0d0c140" class="outline-3">
<h3 id="org0d0c140"><span class="section-number-3">3.2.</span> Sending Rays into Scene</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Its time to ray trace! The ray tracer sends rays through pixels and
computes the color seen in the direction of those rays.
</p>

<p>
Here are the steps:
</p>
<ol class="org-ol">
<li>Calculate the ray from the eye to the pixel.</li>
<li>Determine which objects the ray intersects.</li>
<li>Computer a color for that intersection point.</li>
</ol>

<p>
Some parameters we need:
</p>
<ul class="org-ul">
<li>Aspect ratio</li>
<li>Focal length
This is the distance from the eye to the projection plane.??
IDK what this is, but its a plane in the back</li>
<li>Eye/Camera
This will be at the origin.</li>
</ul>

<p>
The y axis will be up, x axis to the right, and z axis moving backwards,
because hand rules.
</p>
</div>
</div>
<div id="outline-container-org4790889" class="outline-3">
<h3 id="org4790889"><span class="section-number-3">3.3.</span> Example: Rendering a blue-to-white gradient, using Ray Tracing</h3>
<div class="outline-text-3" id="text-3-3">
<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org23f1af5"><span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/ray.h"</span>
<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/vec3.h"</span>

<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this function returns a color for which ray its on.</span>
    <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">unit_direction</span> = unit_vector<span style="color: #c678dd;">(</span>r.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this is to try and put the pixel in the center y</span>
      <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">t</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_direction.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>; 
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the gradient color (blue-white) depends on where the</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">y-value sits.</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">higher y values -&gt; more blue</span>
      <span style="color: #51afef;">return</span> t * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> + <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - t<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">image</span>
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
      <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">height</span> = <span style="color: #da8548; font-weight: bold;">200</span>;
      <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">width</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>height * aspect<span style="color: #c678dd;">)</span>;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera setup</span>

      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">viewport_height</span> = <span style="color: #da8548; font-weight: bold;">2.0</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">viewport_width</span> = viewport_height * aspect;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focal_length</span> = <span style="color: #da8548; font-weight: bold;">1.0</span>;

      <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">origin</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">horizontal</span><span style="color: #c678dd;">(</span>viewport_width, <span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">vertical</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, viewport_height, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">lower_left_corner</span> = origin - horizontal / <span style="color: #da8548; font-weight: bold;">2</span> -
         vertical / <span style="color: #da8548; font-weight: bold;">2</span> - vec3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span>, focal_length<span style="color: #c678dd;">)</span>;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Render</span>
      <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; height
                &lt;&lt; <span style="color: #98be65;">"\n255"</span>  &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">loop</span>
      <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span> = height-<span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">explanation: scans pixels L-&gt;R U-&gt;D</span>
        <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">i thus needs to be in the inner loop</span>

            <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">r</span><span style="color: #a9a1e1;">(</span>origin, vec3<span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">i</span><span style="color: #c678dd;">)</span> * viewport_width / width,
              <span style="color: #ECBE7B;">double</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">j</span><span style="color: #c678dd;">)</span> * viewport_height / height, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #51afef;">)</span>
              + lower_left_corner - origin<span style="color: #a9a1e1;">)</span>;

            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">color pixel = ray_color(r);</span>

             <span style="color: #5B6268;">// </span><span style="color: #5B6268;">double u = double(i) / (width-1); // fraction of width</span>
             <span style="color: #5B6268;">// </span><span style="color: #5B6268;">double v = double(j) / (height-1); // fraction of height</span>
             <span style="color: #5B6268;">// </span><span style="color: #5B6268;">// why write origin here? well its because the origin may not always be [0, 0, 0]</span>
             <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ray r(origin, lower_left_corner + u * horizontal + v * vertical - origin);</span>


             <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">pixel</span> = ray_color<span style="color: #a9a1e1;">(</span>r<span style="color: #a9a1e1;">)</span>;
             write_color<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, pixel<span style="color: #a9a1e1;">)</span>;
          <span style="color: #98be65;">}</span>
      <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b>
</p>

<p>
The resultant image is a gradient from blue to white. Notice that not only is there a
vertical gradient, but also a horizontal one.
To explain this, we look at the <code>ray_color</code> function:
</p>
<div class="org-src-container">
<pre class="src src-C++">  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">unit_direction</span> = unit_vector<span style="color: #c678dd;">(</span>r.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">transformation to make to from 0 to 1</span>
      <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">t</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_direction.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>; 
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the gradient color (blue-white) depends on where the</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">y-value sits.</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">higher y values -&gt; more blue</span>
      <span style="color: #51afef;">return</span> t * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> + <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - t<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>
</pre>
</div>
<p>
Unit vector makes the direction component of the ray unit length.
This means that when we take the y component of all of those rays,
the rays closer to the fringes when normalized dont extend as far
into the y direction (because of some of the length contributed to
the other components of the vector). We can also guarantee that no
y component of any normalised vector will be greater than \(\pm 1\).
We perform a transformation on the y scale to get a t that is \(0 \leq t \leq 1\).
When \(t = 1\), we get blue, and when \(t = 0\) we get white.
As a result the following is produced.
</p>


<div id="org8e3ba1b" class="figure">
<p><img src="./images/gradient-rt.png" alt="gradient-rt.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgcc6b3c6" class="outline-2">
<h2 id="orgcc6b3c6"><span class="section-number-2">4.</span> Adding a sphere to the scene</h2>
<div class="outline-text-2" id="text-4">
<p>
Time to add an object to the ray tracer!
</p>
</div>
<div id="outline-container-orgfe2aadb" class="outline-3">
<h3 id="orgfe2aadb"><span class="section-number-3">4.1.</span> Hit detection</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Recall the equation for a sphere with center \((C_x, C_y, C_z)\):
\[ (x-C_x)^2 + (y-C_y)^2 + (z-C_z)^2 = r^2 \]
</p>

<p>
So to determine if a point \((a, b, c)\) is in a sphere, you would
check if
\[ (x-C_x)^2 + (y-C_y)^2 + (z-C_z)^2 < r^2 \]
</p>
</div>
<div id="outline-container-orga78123f" class="outline-4">
<h4 id="orga78123f"><span class="section-number-4">4.1.1.</span> Expressing as vectors</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Now, \((x-C_x)^2 + (y-C_y)^2 + (z-C_z)^2\) is great and all but
we need it to be in the form of vectors for the <code>vec3</code> class.
Claim: \((\textbf{P - C})\cdot(\textbf{P - C}) = (x-C_x)^2 + (y-C_y)^2 + (z-C_z)^2\),
where \(P\) is a point \((x, y, z)\), and \(C = (C_x, C_y, C_z)\)
is the center of the sphere.
</p>

\begin{align*}
(\textbf{P - C})\cdot(\textbf{P - C}) &=
\left[ {\begin{array}{c}
  x-C_x \\
  y-C_y \\
  z-C_z \\
\end{array}}\right] \cdot
\left[ {\begin{array}{c}
  x-C_x \\
  y-C_y \\
  z-C_z \\
\end{array}}\right] &&\text{Recall the dot product: $a\cdot b = \sum_{i=1}^n a_ib_i$} \\\\
&= (x-C_x)(x-C_x) + (y-C_y)(y-C_y) + (z-C_z)(z-C_z) \\
&= (x-C_x)^2 + (y-C_y)^2 + (z-C_z)^2 \\
\end{align*}

<p>
Thus,
\[(\textbf{P-C})\cdot(\textbf{P-C}) = r^2 \]
</p>
</div>
</div>
<div id="outline-container-org2e118c1" class="outline-4">
<h4 id="org2e118c1"><span class="section-number-4">4.1.2.</span> Detecting if rays hit sphere</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
The above equation only answers whether a point \(\textbf{P}\)
is on the sphere. We want to know if a ray ever hits the
sphere. To do this, we substitute \(\textbf{P}\) for
\(\textbf{P}(t)=\textbf{A} + t\textbf{B}\), and find value
\(t\) such that this equation holds:
</p>
\begin{align*}
(\textbf{P}(t) - \textbf{C})\cdot(\textbf{P}(t) - \textbf{C}) &= r^2 \\
(\textbf{A}+t\textbf{b} - \textbf{C})\cdot
(\textbf{A}+t\textbf{b} - \textbf{C}) &= r^2 \\
(t\textbf{b} + (\textbf{A} - \textbf{C})) \cdot
(t\textbf{b} + (\textbf{A} - \textbf{C})) &= r^2 \\
t^2\textbf{b}*\textbf{b} + 2t\textbf{b}\cdot(\textbf{A-C}) +
(\textbf{A-C})\cdot(\textbf{A-C}) - r^2 &= 0 \\
\end{align*}

<p>
1 intersection means the ray touches the sphere once,
2 intersections means the ray passes through the sphere.
These intersections can be found in this quadratic equation,
but we are only concerned with whether the ray hits the sphere.
</p>

<p>
We have a handy quadratic equation to find roots:
\[x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} \]
</p>

<p>
If \(b^2 - 4ac\) is negative, then there are no roots.
So, for the ray \(\textbf{P}(t) = \textbf{A} + t\textbf{b}\)
to not intersect the shape,
</p>
\begin{align*}
(2b\cdot(\textbf{A-C}))^2 - 4(\textbf{b} \cdot b)((\textbf{A-C})
    \cdot (\textbf{A-C}) - r^2) < 0 \\
\end{align*}
<p>
must hold true.
</p>
</div>
</div>
<div id="outline-container-orge22160d" class="outline-4">
<h4 id="orge22160d"><span class="section-number-4">4.1.3.</span> Example: Adding the shape to our gradient</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
We create a function called <code>hit_sphere</code> which given a sphere, returns whether
the ray hits the sphere.
For now, we color the rays that hit the sphere red in our final result.
</p>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org76272a2"><span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/ray.h"</span>
<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/vec3.h"</span>

<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">check if the ray intersects the sphere</span>
    <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">hit_sphere</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">point3</span>&amp; <span style="color: #dcaeea;">center</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">radius</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">ray</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">org_min_c</span> = ray.origin<span style="color: #c678dd;">()</span> - center;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">a</span> = dot<span style="color: #c678dd;">(</span>ray.direction<span style="color: #98be65;">()</span>, ray.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">b</span> = dot<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">2</span>*ray.direction<span style="color: #98be65;">()</span>, org_min_c<span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">c</span> = dot<span style="color: #c678dd;">(</span>org_min_c, org_min_c<span style="color: #c678dd;">)</span> - radius*radius;
      <span style="color: #51afef;">return</span> b*b - <span style="color: #da8548; font-weight: bold;">4</span>*a*c &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">i left it as geq 0 for now.</span>
    <span style="color: #51afef;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this function returns a color for which ray its on.</span>
    <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>hit_sphere<span style="color: #98be65;">(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">0</span>,-<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, r<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if hit sphere, then color it red.</span>
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">unit_direction</span> = unit_vector<span style="color: #c678dd;">(</span>r.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this is to try and put the pixel in the center y</span>
      <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">t</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_direction.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>; 
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the gradient color (blue-white) depends on where the</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">y-value sits.</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">higher y values -&gt; more blue</span>
      <span style="color: #51afef;">return</span> t * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> + <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - t<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">image</span>
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
      <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">height</span> = <span style="color: #da8548; font-weight: bold;">200</span>;
      <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">width</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>height * aspect<span style="color: #c678dd;">)</span>;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera setup</span>

      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">viewport_height</span> = <span style="color: #da8548; font-weight: bold;">2.0</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">viewport_width</span> = viewport_height * aspect;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focal_length</span> = <span style="color: #da8548; font-weight: bold;">1.0</span>;

      <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">origin</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">horizontal</span><span style="color: #c678dd;">(</span>viewport_width, <span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">vertical</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, viewport_height, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">lower_left_corner</span> = origin - horizontal / <span style="color: #da8548; font-weight: bold;">2</span> -
         vertical / <span style="color: #da8548; font-weight: bold;">2</span> - vec3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span>, focal_length<span style="color: #c678dd;">)</span>;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Render</span>
      <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; height
                &lt;&lt; <span style="color: #98be65;">"\n255"</span>  &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">loop</span>
      <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span> = height-<span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">explanation: scans pixels L-&gt;R U-&gt;D</span>
        <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">i thus needs to be in the inner loop</span>

            <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">r</span><span style="color: #a9a1e1;">(</span>origin, vec3<span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">i</span><span style="color: #c678dd;">)</span> * viewport_width / width,
              <span style="color: #ECBE7B;">double</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">j</span><span style="color: #c678dd;">)</span> * viewport_height / height, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #51afef;">)</span>
              + lower_left_corner - origin<span style="color: #a9a1e1;">)</span>;

             <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">pixel</span> = ray_color<span style="color: #a9a1e1;">(</span>r<span style="color: #a9a1e1;">)</span>;
             write_color<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, pixel<span style="color: #a9a1e1;">)</span>;
          <span style="color: #98be65;">}</span>
      <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output:</b>
</p>

<div id="org4574fce" class="figure">
<p><img src="./images/red-circle.png" alt="red-circle.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org3bf923b" class="outline-3">
<h3 id="org3bf923b"><span class="section-number-3">4.2.</span> Surface Normals</h3>
<div class="outline-text-3" id="text-4-2">
<p>
A surface normal is the vector that is perpendicular to the surface of the point
of intersection.
For a point \(\textbf{P}\) on the sphere with center \(\textbf{C}\),
the normal vector would be \(\textbf{P} - \textbf{C}\).
Convince yourself that this is true.
We also normalize this vector so that each component is between -1 and 1.
</p>
</div>
<div id="outline-container-orge75f2ac" class="outline-4">
<h4 id="orge75f2ac"><span class="section-number-4">4.2.1.</span> Example: Visualizing The Normal</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
For now, we use a color map to visualize the normal. Since each vector is normalized,
each component is between -1 and 1, which we can map to an interval from
0 to 1. Then, we map \(x \mapsto r\), \(y \mapsto g\), and \(z \mapsto b\).
</p>

<p>
Let us visualize this:
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="orgf854b56"><span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/ray.h"</span>
<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #98be65;">"util/vec3.h"</span>

<span style="color: #51afef; font-weight: bold;">    #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">check if the ray intersects the sphere, if so, return the t value of the ray</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">that touches the sphere.</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">hit_sphere</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">point3</span>&amp; <span style="color: #dcaeea;">center</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">radius</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">ray</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">org_min_c</span> = ray.origin<span style="color: #c678dd;">()</span> - center;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">a</span> = dot<span style="color: #c678dd;">(</span>ray.direction<span style="color: #98be65;">()</span>, ray.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">b</span> = dot<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">2</span>*ray.direction<span style="color: #98be65;">()</span>, org_min_c<span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">c</span> = dot<span style="color: #c678dd;">(</span>org_min_c, org_min_c<span style="color: #c678dd;">)</span> - radius*radius;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">discriminant</span> = b*b - <span style="color: #da8548; font-weight: bold;">4</span>*a*c;
      <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>discriminant &lt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">why return -1? When is it -1?</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">means the object is behind the ray...</span>
         <span style="color: #51afef;">return</span> -<span style="color: #da8548; font-weight: bold;">1.0</span>;
      <span style="color: #c678dd;">}</span> <span style="color: #51afef;">else</span> <span style="color: #c678dd;">{</span>
         <span style="color: #51afef;">return</span> <span style="color: #98be65;">(</span>-b - sqrt<span style="color: #a9a1e1;">(</span>discriminant<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> / <span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">2.0</span> * a<span style="color: #98be65;">)</span>;
      <span style="color: #c678dd;">}</span>
    <span style="color: #51afef;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this function returns a color for which ray its on.</span>
    <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">sphere_center</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">0</span>,-<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span> = hit_sphere<span style="color: #c678dd;">(</span>sphere_center, <span style="color: #da8548; font-weight: bold;">0.5</span>, r<span style="color: #c678dd;">)</span>;
      <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>t &gt; <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">calculate the norm (P - C)</span>
         <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">norm</span> = unit_vector<span style="color: #98be65;">(</span>r.origin<span style="color: #a9a1e1;">()</span> + t * r.direction<span style="color: #a9a1e1;">()</span> - sphere_center<span style="color: #98be65;">)</span>;
         <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #98be65;">(</span>norm + vec3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>; 
      <span style="color: #c678dd;">}</span>
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">unit_direction</span> = unit_vector<span style="color: #c678dd;">(</span>r.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this is to try and put the pixel in the center y</span>
      t = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_direction.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>; 
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the gradient color (blue-white) depends on where the</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">y-value sits.</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">higher y values -&gt; more blue</span>
      <span style="color: #51afef;">return</span> t * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> + <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - t<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">image</span>
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
      <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">height</span> = <span style="color: #da8548; font-weight: bold;">200</span>;
      <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">width</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>height * aspect<span style="color: #c678dd;">)</span>;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera setup</span>
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">viewport_height</span> = <span style="color: #da8548; font-weight: bold;">2.0</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">viewport_width</span> = viewport_height * aspect;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focal_length</span> = <span style="color: #da8548; font-weight: bold;">1.0</span>;

      <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">origin</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">horizontal</span><span style="color: #c678dd;">(</span>viewport_width, <span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">vertical</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, viewport_height, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">lower_left_corner</span> = origin - horizontal / <span style="color: #da8548; font-weight: bold;">2</span> -
         vertical / <span style="color: #da8548; font-weight: bold;">2</span> - vec3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.0</span>, <span style="color: #da8548; font-weight: bold;">0.0</span>, focal_length<span style="color: #c678dd;">)</span>;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Render</span>
      <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; height
                &lt;&lt; <span style="color: #98be65;">"\n255"</span>  &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">loop</span>
      <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span> = height-<span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">explanation: scans pixels L-&gt;R U-&gt;D</span>
        <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">i thus needs to be in the inner loop</span>
            <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">r</span><span style="color: #a9a1e1;">(</span>origin, vec3<span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">i</span><span style="color: #c678dd;">)</span> * viewport_width / width,
              <span style="color: #ECBE7B;">double</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">j</span><span style="color: #c678dd;">)</span> * viewport_height / height, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #51afef;">)</span>
              + lower_left_corner - origin<span style="color: #a9a1e1;">)</span>;
             <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">pixel</span> = ray_color<span style="color: #a9a1e1;">(</span>r<span style="color: #a9a1e1;">)</span>;
             write_color<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, pixel<span style="color: #a9a1e1;">)</span>;
          <span style="color: #98be65;">}</span>
      <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output:</b>
</p>

<div id="org73b785c" class="figure">
<p><img src="./images/color-map-sphere.png" alt="color-map-sphere.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org3bfdd0a" class="outline-3">
<h3 id="org3bfdd0a"><span class="section-number-3">4.3.</span> Simplifying the intersection code.</h3>
<div class="outline-text-3" id="text-4-3">
<p>
There is an extra 2 in the front of b in our equation. Suppose we then used
\(b = 2h\) in our quadratic equation:
</p>
\begin{align*}
 \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} \\
= \frac{-(2h) \pm \sqrt{(2h)^2 - 4ac}}{2a} \\
= \frac{-2h \pm \sqrt{4h^2 - 4ac}}{2a} \\
= \frac{-2h \pm 2\sqrt{h^2 - ac}}{2a} \\
= \frac{-h \pm \sqrt{h^2 - ac}}{a} \\
\end{align*}
<p>
Now we use these changes in our code:
</p>
<div class="org-src-container">
<pre class="src src-C++">    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">check if the ray intersects the sphere, if so, return the t value of the ray</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">that touches the sphere.</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">hit_sphere</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">point3</span>&amp; <span style="color: #dcaeea;">center</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">radius</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">ray</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">org_min_c</span> = ray.origin<span style="color: #c678dd;">()</span> - center;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">a</span> = dot<span style="color: #c678dd;">(</span>ray.direction<span style="color: #98be65;">()</span>, ray.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">h_b</span> = dot<span style="color: #c678dd;">(</span>ray.direction<span style="color: #98be65;">()</span>, org_min_c<span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">c</span> = dot<span style="color: #c678dd;">(</span>org_min_c, org_min_c<span style="color: #c678dd;">)</span> - radius*radius;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">discriminant</span> = h_b*h_b - a*c;
      <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>discriminant &lt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">why return -1? When is it -1?</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">means the object is behind the ray...</span>
         <span style="color: #51afef;">return</span> -<span style="color: #da8548; font-weight: bold;">1.0</span>;
      <span style="color: #c678dd;">}</span> <span style="color: #51afef;">else</span> <span style="color: #c678dd;">{</span>
         <span style="color: #51afef;">return</span> <span style="color: #98be65;">(</span>-h_b - sqrt<span style="color: #a9a1e1;">(</span>discriminant<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> / a;
      <span style="color: #c678dd;">}</span>
    <span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgee3de0f" class="outline-3">
<h3 id="orgee3de0f"><span class="section-number-3">4.4.</span> Abstraction to hittable objects</h3>
<div class="outline-text-3" id="text-4-4">
<p>
So what about several spheres? Or shapes? Let&rsquo;s generalize this problem
into an abstract class.
This generalized &ldquo;surface&rdquo; is anything that can be hit by rays.
</p>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hit_record</span> <span style="color: #51afef;">{</span>
  <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">point</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">point of intersection</span>
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">norm</span>;    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">resultant norm of the intersection</span>
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span>;     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">t-value of ray to get to point.</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">hittable</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">public</span>:
    <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">hit</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_max</span>, <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>

</pre>
</div>

<p>
So we use this general class to implmement a sphere.
</p>

<div class="org-src-container">
<pre class="src src-C++"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">sphere</span> : <span style="color: #51afef;">public</span> <span style="color: #ECBE7B;">hittable</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">sphere</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{}</span>
  <span style="color: #c678dd;">sphere</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">center</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">r</span><span style="color: #c678dd;">)</span> : center<span style="color: #c678dd;">(</span>center<span style="color: #c678dd;">)</span>, radius<span style="color: #c678dd;">(</span>r<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>;

  <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">hit</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_max</span>, <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">override</span>;

  <span style="color: #51afef;">public</span>:
    <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">center</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">radius</span>;
<span style="color: #51afef;">}</span>

<span style="color: #ECBE7B;">bool</span> <span style="color: #a9a1e1;">sphere</span>::<span style="color: #c678dd;">hit</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp;<span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_max</span>, <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">{</span>
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">org_min_c</span> = r.origin<span style="color: #c678dd;">()</span> - center;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">a</span> = dot<span style="color: #c678dd;">(</span>r.direction<span style="color: #98be65;">()</span>, r.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">h_b</span> = dot<span style="color: #c678dd;">(</span>ray.direction<span style="color: #98be65;">()</span>, org_min_c<span style="color: #c678dd;">)</span>;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">c</span> = dot<span style="color: #c678dd;">(</span>org_min_c, org_min_c<span style="color: #c678dd;">)</span> - radius*radius;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">discriminant</span> = h_b*h_b - a*c;
  <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>discriminant &lt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>;
  <span style="color: #c678dd;">}</span> <span style="color: #51afef;">else</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">sqrtd</span> = <span style="color: #a9a1e1;">std</span>::sqrt<span style="color: #98be65;">(</span>discriminant<span style="color: #98be65;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">root</span> = <span style="color: #98be65;">(</span>-h - sqrtd<span style="color: #98be65;">)</span> / a;
    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>t_min &gt; root || t_max &lt; root<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      root = <span style="color: #a9a1e1;">(</span>-h + sqrtd<span style="color: #a9a1e1;">)</span> / a;
      <span style="color: #51afef;">if</span> <span style="color: #a9a1e1;">(</span>t_min &gt; root || t_max &lt; root<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>;
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span>
    rec.t = root;
    rec.point = r.at<span style="color: #98be65;">(</span>rec.t<span style="color: #98be65;">)</span>;
    rec.norm = unit_vector<span style="color: #98be65;">(</span>rec.point - center<span style="color: #98be65;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this will always be radius</span>

    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>;
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
<div id="outline-container-org3aba30b" class="outline-4">
<h4 id="org3aba30b"><span class="section-number-4">4.4.1.</span> Front Faces vs Back Faces</h4>
<div class="outline-text-4" id="text-4-4-1">
<p>
In the code above, the normal always points outwards from the center of the sphere, even
if the ray intersects the sphere from the inside.
</p>

<p>
From the book, it says that we need to know which side the ray is on
when we color the sphere. If we choose to always have the normal on the outside,
then we will need to do a dot product to check the side.
</p>

<p>
If we always decide to return the normal against the direction of the ray,
then we will also need to provide information on whether the ray is
inside or outside.
</p>

<p>
In terms of which method to choose, the second one determines the side at geometry
intersection, whereas the first one determines at time of coloring. As the book
says, it is a matter of preference but because this book has more material types
than geometry types they have decided to put the determination at geometry
intersection time, to save work.
</p>

<p>
Let us update the appropriate sections of code:
</p>

<p>
First, we need to add an extra member to the <a href="util/hittable.h"><code>hit_record</code></a> struct, to store side information.
</p>

<div class="org-src-container">
<pre class="src src-C++">
  <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hit_record</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">point</span>;
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">norm</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span>;
    <span style="color: #ECBE7B;">bool</span> <span style="color: #dcaeea;">front_face</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">confusing as to why its called front</span>

    <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">set_face_normal</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #dcaeea;">out_norm</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      front_face = dot_product<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span>, out_norm<span style="color: #98be65;">)</span> &lt; <span style="color: #da8548; font-weight: bold;">0</span>;
      norm = front_face ? out_norm : -out_norm;
    <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>

</pre>
</div>

<p>
How does this affect our sphere implementation?
</p>

<div class="org-src-container">
<pre class="src src-C++">  <span style="color: #ECBE7B;">bool</span> <span style="color: #a9a1e1;">sphere</span>::<span style="color: #c678dd;">hit</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp;<span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_max</span>, <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">ve</span> <span style="color: #dcaeea;">org_min_c</span> = r.origin<span style="color: #c678dd;">()</span> - center;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">a</span> = dot<span style="color: #c678dd;">(</span>r.direction<span style="color: #98be65;">()</span>, r.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">h_b</span> = dot<span style="color: #c678dd;">(</span>ray.direction<span style="color: #98be65;">()</span>, org_min_c<span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">c</span> = dot<span style="color: #c678dd;">(</span>org_min_c, org_min_c<span style="color: #c678dd;">)</span> - radius*radius;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">discriminant</span> = h_b*h_b - a*c;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>discriminant &lt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>;
    <span style="color: #c678dd;">}</span> <span style="color: #51afef;">else</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">sqrtd</span> = <span style="color: #a9a1e1;">std</span>::sqrt<span style="color: #98be65;">(</span>discriminant<span style="color: #98be65;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">root</span> = <span style="color: #98be65;">(</span>-h - sqrtd<span style="color: #98be65;">)</span> / a;
      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>t_min &gt; root || t_max &lt; root<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        root = <span style="color: #a9a1e1;">(</span>-h + sqrtd<span style="color: #a9a1e1;">)</span> / a;
        <span style="color: #51afef;">if</span> <span style="color: #a9a1e1;">(</span>t_min &gt; root || t_max &lt; root<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
          <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>;
        <span style="color: #a9a1e1;">}</span>
      <span style="color: #98be65;">}</span>
      rec.t = root;
      rec.point = r.at<span style="color: #98be65;">(</span>rec.t<span style="color: #98be65;">)</span>;
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">rec.norm = unit_vector(rec.point - center); // this will always be radius</span>
      rec.set_face_normal<span style="color: #98be65;">(</span>r, unit_vector<span style="color: #a9a1e1;">(</span>rec.point - center<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>;

      <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>;
    <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>
<p>
The sphere implmentation can be found <a href="util/sphere.h">here</a>.
</p>
</div>
</div>
<div id="outline-container-orgfa6c9f8" class="outline-4">
<h4 id="orgfa6c9f8"><span class="section-number-4">4.4.2.</span> A List of Hittable Objects</h4>
<div class="outline-text-4" id="text-4-4-2">
<p>
With a generic object like hittable, we can make a class to store all the hittables! Now,
we can do hit detection on a collection of objects.
</p>

<p>
The file can be found <a href="util/hittable_list.h">here</a>.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">public</span>:
    <span style="color: #c678dd;">hittable_list</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{}</span>
    <span style="color: #c678dd;">hittable_list</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">shared_ptr</span><span style="color: #98be65;">&lt;</span>hittable<span style="color: #98be65;">&gt;</span> <span style="color: #dcaeea;">object</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>add<span style="color: #98be65;">(</span>object<span style="color: #98be65;">)</span>;<span style="color: #c678dd;">}</span>

    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">clear</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span> objects.clear<span style="color: #98be65;">()</span>; <span style="color: #c678dd;">}</span>
    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">add</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">shared_ptr</span><span style="color: #98be65;">&lt;</span>hittable<span style="color: #98be65;">&gt;</span> <span style="color: #dcaeea;">object</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      objects.push_back<span style="color: #98be65;">(</span>object<span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">hit</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_max</span>, <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">override</span>;

  <span style="color: #51afef;">public</span>:
    <span style="color: #ECBE7B;">vector</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">shared_ptr</span><span style="color: #98be65;">&lt;</span>hittable<span style="color: #98be65;">&gt;</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">objects</span>;
<span style="color: #51afef;">}</span>;

<span style="color: #ECBE7B;">bool</span> <span style="color: #a9a1e1;">hittable_list</span>::<span style="color: #c678dd;">hit</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_max</span>, <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">probably want to distinguish between objects in front or behind</span>
  <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec_temp</span>;
  <span style="color: #ECBE7B;">bool</span> <span style="color: #dcaeea;">is_hit</span> = <span style="color: #a9a1e1;">false</span>;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">closest_hit</span> = t_max;
  
  <span style="color: #51afef;">for</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #51afef;">auto</span> &amp;<span style="color: #dcaeea;">obj</span> : objects<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>obj-&gt;hit<span style="color: #a9a1e1;">(</span>r, t_min, closest_hit, rec_temp<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      is_hit = <span style="color: #a9a1e1;">true</span>;
      closest_hit = rec.t;
      rec = rec_temp;
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #51afef;">return</span> is_hit;
<span style="color: #51afef;">}</span>;

</pre>
</div>
</div>
</div>
<div id="outline-container-org7689bf9" class="outline-4">
<h4 id="org7689bf9"><span class="section-number-4">4.4.3.</span> Wrapping Up With a Revised Example</h4>
<div class="outline-text-4" id="text-4-4-3">
<p>
Returning to the previous example, we re-write the program, now with another sphere
in the world, with radius 100 and centered around \((0, -100.5, -1)\).
</p>

<p>
The header file <a href="util/rtweekend.h"><code>rtweekend</code></a> has some useful constants like
infinity and pi, and a function for converting
degrees to radians.
</p>

<p>
<i>Note to Self: Remember to add semicolons to the end of your class/struct
declarations, as the errors that arise (Expected unqualified id) are not
very helpful.</i>
</p>

<p>
<b>Source:</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org3588833"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if hit, return a color map</span>
      <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #98be65;">(</span>rec.norm + vec3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">set up width and height</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span>/<span style="color: #da8548; font-weight: bold;">9.0</span>;
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">set up camera</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_height</span> = <span style="color: #da8548; font-weight: bold;">2.0</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">we choose height here because height is known</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_width</span> = vp_height * aspect;

    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focal_length</span> = <span style="color: #da8548; font-weight: bold;">1.0</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">useful parameters</span>
    <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">origin</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">horizontal</span><span style="color: #c678dd;">(</span>vp_width, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">vertical</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, vp_height, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">lower_left</span> = origin - horizontal / <span style="color: #da8548; font-weight: bold;">2</span> - vertical / <span style="color: #da8548; font-weight: bold;">2</span> - vec3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, focal_length<span style="color: #c678dd;">)</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">set up the world</span>
    <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;


    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render time</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

    <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span> = img_height-<span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">r</span><span style="color: #a9a1e1;">(</span>origin, lower_left + vertical * <span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">j</span><span style="color: #c678dd;">)</span> / img_height<span style="color: #51afef;">)</span> +
                      horizontal * <span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">i</span><span style="color: #c678dd;">)</span> / img_width<span style="color: #51afef;">)</span> - origin<span style="color: #a9a1e1;">)</span>;
        write_color<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, ray_color<span style="color: #51afef;">(</span>r, world<span style="color: #51afef;">)</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>
    <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>

</pre>
</div>

<p>
<b>Output:</b>
In the camera view, we see the original sphere as well as the gradient in the back
where no rays intersected any object. The green curvature is the top of the massive
sphere with radius 100, and it is green due to how our colormap was designed:
(normal with big positive y component \(\implies\) larger green value.)
</p>


<div id="org40c3212" class="figure">
<p><img src="./images/color-map-spheres.png" alt="color-map-spheres.png" />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org5123707" class="outline-2">
<h2 id="org5123707"><span class="section-number-2">5.</span> Antialiasing</h2>
<div class="outline-text-2" id="text-5">
<p>
Notice the jagged lines of the smooth surface of the sphere. This is aliasing.
To get rid of this effect, we can average a bunch of pixels around the area to make it
look smoother.
The book says that we will not bother with <i>stratification</i>, but this may be
something that I might look into later. The argument offered as to why
we will not implement stratification is because our ray-tracer will not
benefit much from this and makes the code much more complex.
</p>

<p>
To begin, we start with some more abstractions.
</p>
</div>
<div id="outline-container-org0152494" class="outline-3">
<h3 id="org0152494"><span class="section-number-3">5.1.</span> Random Number Generation</h3>
<div class="outline-text-3" id="text-5-1">
<p>
We need some helper functions to generate random doubles.
First, we create one that can generate a double in the range \([0, 1)\), with
the help of cstdlib.
</p>
<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">cstdlib</span><span style="color: #51afef;">&gt;</span>
  
  <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">random_double</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Returns a random real in [0,1).</span>
      <span style="color: #51afef;">return</span> rand<span style="color: #c678dd;">()</span> / <span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">RAND_MAX</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

</pre>
</div>

<p>
Then, let&rsquo;s extend this to create a function that gives a random double
in a range:
</p>

<div class="org-src-container">
<pre class="src src-C++">
  <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">random_double</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">max</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">return</span> min + <span style="color: #c678dd;">(</span>max - min<span style="color: #c678dd;">)</span> * random_double<span style="color: #c678dd;">()</span>;
  <span style="color: #51afef;">}</span>

</pre>
</div>

<p>
These will be added to our <a href="util/rtweekend.h">rtweekend.h</a> header file.
</p>
</div>
</div>
<div id="outline-container-org6fbe4b8" class="outline-3">
<h3 id="org6fbe4b8"><span class="section-number-3">5.2.</span> Abstracting the Camera</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Given a pixel we have several samples and send rays through each of the samples. The colors are then
averaged.
Let&rsquo;s create a camera class to manage the virtual camera and screen sampling.
The camera has:
</p>
<ul class="org-ul">
<li>Aspect Ratio</li>
<li>viewport width/height</li>
<li>focal length</li>
</ul>
<p>
and some useful constants, like
</p>
<ul class="org-ul">
<li><code>vec3</code> horizontal [viewport<sub>width</sub>, 0, 0]</li>
<li><code>vec3</code> vertical [0, viewport<sub>height</sub>, 0]</li>
<li><code>vec3</code> bot<sub>left</sub> \(\leftarrow\) origin - horizontal / 2 - vertical / 2 - [0, 0, -focal<sub>length</sub>]</li>
</ul>
<p>
Some functions that the camera has might be the <code>get_ray</code> function that returns a ray for a cartesian
coordinate given.
</p>

<p>
The header file can be found here.
</p>
<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">camera</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">camera</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_height</span> = <span style="color: #da8548; font-weight: bold;">2.0</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_width</span> = vp_height * aspect;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focal_length</span> = <span style="color: #da8548; font-weight: bold;">1.0</span>;

    origin = vec3<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    horizontal = vec3<span style="color: #98be65;">(</span>vp_width, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    vertical = vec3<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, vp_height, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    lower_left =
        origin - horizontal / <span style="color: #da8548; font-weight: bold;">2</span> - vertical / <span style="color: #da8548; font-weight: bold;">2</span> - vec3<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, focal_length<span style="color: #98be65;">)</span>;
  <span style="color: #c678dd;">}</span>

  <span style="color: #ECBE7B;">ray</span> <span style="color: #c678dd;">get_ray</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">return</span> ray<span style="color: #98be65;">(</span>origin, lower_left + horizontal * u + vertical * v - origin<span style="color: #98be65;">)</span>;
  <span style="color: #c678dd;">}</span>

<span style="color: #51afef;">public</span>:
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">origin</span>;
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">horizontal</span>;
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">vertical</span>;
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">lower_left</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div>

<p>
Now to handle multi-sampled coloring, we must modify the coloring function in <code>color.h</code>:
</p>
<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">write_color</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">ostream</span> &amp;<span style="color: #dcaeea;">out</span>, <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">pixel_color</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Write the translated [0,255] value of each color component.</span>
  out &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * pixel_color.x<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">' '</span>
      &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * pixel_color.y<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">' '</span>
      &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">255.999</span> * pixel_color.z<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">'\n'</span>;
<span style="color: #51afef;">}</span>
  
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">write_color_aa</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">ostream</span> &amp;<span style="color: #dcaeea;">out</span>, <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">pixel_color</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_pixel</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">get pixel color.</span>
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">r</span> = pixel_color.x<span style="color: #c678dd;">()</span>;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">g</span> = pixel_color.y<span style="color: #c678dd;">()</span>;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">b</span> = pixel_color.z<span style="color: #c678dd;">()</span>;

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">divide by samples per px</span>
  r /= samples_per_pixel;
  g /= samples_per_pixel;
  b /= samples_per_pixel;

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Write the translated [0,255] value of each color component.</span>
  out &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">256</span> * clamp<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0.999</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">' '</span>
      &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">256</span> * clamp<span style="color: #98be65;">(</span>g, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0.999</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">' '</span>
      &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">256</span> * clamp<span style="color: #98be65;">(</span>b, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0.999</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">'\n'</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
Why use clamp instead of multiplying it by 255.999? I guess it ensures for sure that
the r, g, and b component will be between 0 and 255 (truncated, inclusive).
Now it&rsquo;s time to adapt this change to our main function.
</p>

<p>
<b>Source:</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org53a3d9f"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if hit, return a color map</span>
      <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #98be65;">(</span>rec.norm + vec3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_aa<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>


<p>
<b>OUTPUT:</b>
</p>

<p>
The result is a much smoother sphere, with no jagged lines.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Before</td>
<td class="org-left">After</td>
</tr>

<tr>
<td class="org-left"><img src="./images/color-map-spheres.png" alt="color-map-spheres.png" /></td>
<td class="org-left"><img src="./images/color-map-spheres-aa.png" alt="color-map-spheres-aa.png" /> 100 samples</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><img src="./images/color-map-spheres-aa-1000.png" alt="color-map-spheres-aa-1000.png" /> 1000 samples</td>
</tr>
</tbody>
</table>

<p>
The visual improvements from 100 to 1000 samples is minor, but takes a lot
longer to render.
</p>
</div>
</div>
</div>
<div id="outline-container-org9310e5f" class="outline-2">
<h2 id="org9310e5f"><span class="section-number-2">6.</span> Diffuse Materials</h2>
<div class="outline-text-2" id="text-6">
<p>
Now that we have objects and multiple rays per pixel, we can make some materials.
To start, let&rsquo;s do diffuse (matte) materials.
</p>
</div>
<div id="outline-container-org371fd54" class="outline-3">
<h3 id="org371fd54"><span class="section-number-3">6.1.</span> Simple diffuse material</h3>
<div class="outline-text-3" id="text-6-1">
<p>
The material takes the rays, and scatters them into random directions.
These materials do not emit light but they can modulate that with their own
color (whatever that means)
</p>

<p>
Diffuse material might also absorb the ray (that&rsquo;s why darker surfaces look
dark).
</p>

<p>
We will first use a hacky algorithm that randomizes direction, a &ldquo;hacky lambertian&rdquo;
algorithm for ideal diffuse surfaces.
</p>

<p>
<span class="underline">The Algorithm</span> <br />
There are two unit radius spheres tangent to the hit point p of a surface.
These two spheres have a center of \(\mathbf{P} - \mathbf{n}\) or \(\mathbf{P} + \mathbf{n}\).
The sphere with a center of \(\mathbf{P} - \mathbf{n}\) is considered <i>inside</i> of the surface, and
\(\mathbf{P} + \mathbf{n}\) is considered outside of the surface. We select the tangent that is on the
same side as the ray origin. Pick a random point \(\mathbf{S}\) inside this unit sphere and send a
ray from the hit point \(\mathbf{P}\) to the random point \(\mathbf{S}\).
</p>

<p>
<i>Note</i>: How do we get a random point in a unit sphere? For now, we will find a random point
in a unit cube and re-draw the point if it is not in the unit sphere.
</p>

<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">put these inside our vec3 class</span>
  <span style="color: #51afef;">inline</span> <span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">random</span><span style="color: #51afef;">(){</span>
      <span style="color: #51afef;">return</span> vec3<span style="color: #c678dd;">(</span>random_double<span style="color: #98be65;">()</span>, random_double<span style="color: #98be65;">()</span>, random_double<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #51afef;">inline</span> <span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">random</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">max</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      <span style="color: #51afef;">return</span> vec3<span style="color: #c678dd;">(</span>random_double<span style="color: #98be65;">(</span>min, max<span style="color: #98be65;">)</span>, random_double<span style="color: #98be65;">(</span>min, max<span style="color: #98be65;">)</span>, random_double<span style="color: #98be65;">(</span>min, max<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
  <span style="color: #51afef;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">put these in the vec3 header</span>
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">random_in_unit_sphere</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">while</span> <span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">true</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">p</span> = <span style="color: #a9a1e1;">vec3</span>::random<span style="color: #98be65;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">)</span>;
      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>p.length_squared<span style="color: #a9a1e1;">()</span> &gt;= <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">)</span> <span style="color: #51afef;">continue</span>;
      <span style="color: #51afef;">return</span> p;
    <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>

</pre>
</div>

<p>
Update the ray<sub>color</sub>() function, as well
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">target</span> = rec.p + rec.normal + random_in_unit_sphere<span style="color: #98be65;">()</span>;
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">calls ray_color again to see where the light scatters to</span>
      <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0.5</span> * ray_color<span style="color: #98be65;">(</span>ray<span style="color: #a9a1e1;">(</span>rec.p, target - rec.p, world<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
However, this only stops recursing when there are no more collisions. This will be detrimental to
the performance of the program, so make sure there is a maximum recursion depth.
</p>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org37a66df"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if hit, return a color map</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">return 0.5 * (rec.norm + vec3(1, 1, 1));</span>

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">calculate point in sphere</span>
      <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">target</span> = rec.point + rec.norm + random_in_unit_sphere<span style="color: #98be65;">()</span>;
      <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0.5</span> * ray_color<span style="color: #98be65;">(</span>ray<span style="color: #a9a1e1;">(</span>rec.point, target - rec.point<span style="color: #a9a1e1;">)</span>, world, depth-<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_aa<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Result</b> <br />
Even with only a <code>max_depth</code> of 50, that took a very long time to process on
my computer.
</p>


<div id="org1bdc14d" class="figure">
<p><img src="./images/spheres-diffuse.png" alt="spheres-diffuse.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orge0f0646" class="outline-3">
<h3 id="orge0f0646"><span class="section-number-3">6.2.</span> Using Gamma Correction for Accurate Color Intensity</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Note that there is a bit of shadowing under the sphere. These spheres should look
light (irl a light gray, since the sphere absorbs 50% of the light).
The reason for this is due to how humans perceive light, and I&rsquo;ll leave this
article here for future reading: <a href="https://www.wikiwand.com/en/Gamma_correction">Gamma Correction</a>
</p>

<p>
Basically, the brightness needs to be adjusted for human consumption.
Image viewers assume that the image is already corrected, so we will have to perform
a correction.
</p>

<p>
We can first use a &ldquo;gamma 2&rdquo; correction, meaning \(\text{color}^\frac{1}{\gamma}\).
We will use \(\gamma = 2\), which means the correction is a square root on the color.
Let&rsquo;s see what this does:
</p>

<div class="org-src-container">
<pre class="src src-C++">  <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">write_color_gamma</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">ostream</span> &amp;<span style="color: #dcaeea;">out</span>, <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">pixel_color</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_pixel</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">get pixel color.</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">r</span> = pixel_color.x<span style="color: #c678dd;">()</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">g</span> = pixel_color.y<span style="color: #c678dd;">()</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">b</span> = pixel_color.z<span style="color: #c678dd;">()</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">divide by samples per px, then apply gamma correction</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">by raising the value to 0.5 (aka a sqrt)</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">scale</span> = <span style="color: #da8548; font-weight: bold;">1.0</span> / samples_per_pixel;
    r = sqrt<span style="color: #c678dd;">(</span>scale * r<span style="color: #c678dd;">)</span>;
    g = sqrt<span style="color: #c678dd;">(</span>scale * g<span style="color: #c678dd;">)</span>;
    b = sqrt<span style="color: #c678dd;">(</span>scale * b<span style="color: #c678dd;">)</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Write the translated [0,255] value of each color component.</span>
    out &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">256</span> * clamp<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0.999</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">' '</span>
        &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">256</span> * clamp<span style="color: #98be65;">(</span>g, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0.999</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">' '</span>
        &lt;&lt; <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">256</span> * clamp<span style="color: #98be65;">(</span>b, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0.999</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #98be65;">'\n'</span>;
  <span style="color: #51afef;">}</span>
</pre>
</div>


<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org63e2de6"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if hit, return a color map</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">return 0.5 * (rec.norm + vec3(1, 1, 1));</span>

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">calculate point in sphere</span>
      <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">target</span> = rec.point + rec.norm + random_in_unit_sphere<span style="color: #98be65;">()</span>;
      <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0.5</span> * ray_color<span style="color: #98be65;">(</span>ray<span style="color: #a9a1e1;">(</span>rec.point, target - rec.point<span style="color: #a9a1e1;">)</span>, world, depth-<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>


<div id="orgc055b69" class="figure">
<p><img src="./images/spheres-diffuse-gammac.png" alt="spheres-diffuse-gammac.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgcc540e8" class="outline-3">
<h3 id="orgcc540e8"><span class="section-number-3">6.3.</span> Shadow Acne</h3>
<div class="outline-text-3" id="text-6-3">
<p>
We need to account for floating point error, so there is a slight fix we need to make in our
main code. When we send a primary ray out into the world and it collides with a surface,
because we are working with floating point numbers, there is some precision problems.
One such case is if the resultant intersection is actually slightly below the surface of
the object, and then the boi hits itself (because normal points it at the surface right above the point)
This is called <a href="https://www.scratchapixel.com/lessons/3d-basic-rendering/introduction-to-shading/ligth-and-shadows.html"><b>shadow acne</b></a>.
To fix this, we need to ignore hits close but less than zero.
</p>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org85db1a4"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if hit, return a color map</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">return 0.5 * (rec.norm + vec3(1, 1, 1));</span>

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">calculate point in sphere</span>
      <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">target</span> = rec.point + rec.norm + random_in_unit_sphere<span style="color: #98be65;">()</span>;
      <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0.5</span> * ray_color<span style="color: #98be65;">(</span>ray<span style="color: #a9a1e1;">(</span>rec.point, target - rec.point<span style="color: #a9a1e1;">)</span>, world, depth-<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>; world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b>: 
Note: Now it looks a lot brighter. Must have been the shadow acne making things bad then.
</p>

<div id="orgc4e29d7" class="figure">
<p><img src="./images/spheres-diffuse-gammac-noacne.png" alt="spheres-diffuse-gammac-noacne.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org7de5f43" class="outline-3">
<h3 id="org7de5f43"><span class="section-number-3">6.4.</span> True Lambertian Reflection</h3>
<div class="outline-text-3" id="text-6-4">
<p>
So, the reject method (generate a point in a 1x1x1 cube and reject anything that isn&rsquo;t on the sphere)
gives a random point in a unit sphere
</p>

<div class="org-src-container">
<pre class="src src-C++">  <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">random_unit_vector</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">return</span> unit_vector<span style="color: #c678dd;">(</span>random_in_unit_sphere<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>
</pre>
</div>


<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org45f814e"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if hit, return a color map</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">return 0.5 * (rec.norm + vec3(1, 1, 1));</span>

      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">calculate point in sphere</span>
      <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">target</span> = rec.point + rec.norm + random_unit_vector<span style="color: #98be65;">()</span>;
      <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0.5</span> * ray_color<span style="color: #98be65;">(</span>ray<span style="color: #a9a1e1;">(</span>rec.point, target - rec.point<span style="color: #a9a1e1;">)</span>, world, depth-<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>; world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b>
There are two important differences between this one and the last one:
</p>
<ol class="org-ol">
<li>The shadows are less pronounced after this change</li>
<li>Both spheres are lighter in appearance after the change.</li>
</ol>

<div id="orgcc3c5ae" class="figure">
<p><img src="./images/spheres-diffuse-gammac-noacne-truelamb.png" alt="spheres-diffuse-gammac-noacne-truelamb.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org5b369e1" class="outline-3">
<h3 id="org5b369e1"><span class="section-number-3">6.5.</span> Another Diffuse Formulation</h3>
<div class="outline-text-3" id="text-6-5">
<p>
This one is called hemispherical scattering. It is very intuitive, where you have a uniform
scatter direction for all anges away from the hit point.
According to the book, many of the first raytracing papers used this diffuse method before
adopting the Lambertian diffuse.
I will include the function in vec3, but will not show the modified <code>ray_color()</code> function.
</p>

<p>
From the book:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">random_in_hemisphere</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #dcaeea;">normal</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">in_unit_sphere</span> = random_in_unit_sphere<span style="color: #c678dd;">()</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>dot<span style="color: #98be65;">(</span>in_unit_sphere, normal<span style="color: #98be65;">)</span> &gt; <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">In the same hemisphere as the normal</span>
        <span style="color: #51afef;">return</span> in_unit_sphere;
    <span style="color: #51afef;">else</span>
        <span style="color: #51afef;">return</span> -in_unit_sphere;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org39602b2" class="outline-2">
<h2 id="org39602b2"><span class="section-number-2">7.</span> Metal</h2>
<div class="outline-text-2" id="text-7">
<p>
Let&rsquo;s try to make a metal material.
</p>
</div>
<div id="outline-container-orgdcb6b8e" class="outline-3">
<h3 id="orgdcb6b8e"><span class="section-number-3">7.1.</span> Abstracting materials</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Create an abstract material class that encapsulates behaviour - in this case, the material
needs to do two things:
</p>
<ol class="org-ol">
<li>Scatter a ray</li>
</ol>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="orgd45a4e4"><span style="color: #51afef; font-weight: bold;">  #if</span><span style="color: #51afef; font-weight: bold;">n</span><span style="color: #51afef; font-weight: bold;">def</span> <span style="color: #a9a1e1;">MATERIAL_H</span>
<span style="color: #51afef; font-weight: bold;">  #define</span> <span style="color: #dcaeea;">MATERIAL_H</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"rtweekend.h"</span>

  <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hit_record</span>;

  <span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">material</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">public</span>:
    <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">scatter</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r_in</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span>, <span style="color: #ECBE7B;">color</span>&amp; <span style="color: #dcaeea;">attenuation</span>,
                         <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">scattered</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
  <span style="color: #51afef;">}</span>;

<span style="color: #51afef; font-weight: bold;">  #endif</span>
</pre>
</div>

<p>
The hit record is used to group a bunch of related arguments into a data structure, to clean
up the function signuatures. We will add a new attribute to the struct,
a material (which we will call to get where the ray bounces off if it hits the hittable).
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">hit_record</span> <span style="color: #51afef;">{</span>
  <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">point</span>;
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">norm</span>;
  <span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>material<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">mat_ptr</span>;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span>;
  <span style="color: #ECBE7B;">bool</span> <span style="color: #dcaeea;">front_face</span>;

  <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">set_face_normal</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #dcaeea;">out_norm</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    front_face = dot<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span>, out_norm<span style="color: #98be65;">)</span> &lt; <span style="color: #da8548; font-weight: bold;">0</span>;
    norm = front_face ? out_norm : -out_norm;
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>;
</pre>
</div>

<p>
It&rsquo;s a shared pointer, because there can be many objects that point to the same material.
Now, we update the <code>sphere</code> class so that we can assign spheres materials.
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">sphere</span> : <span style="color: #51afef;">public</span> <span style="color: #ECBE7B;">hittable</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">sphere</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{}</span>
  <span style="color: #c678dd;">sphere</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">center</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">r</span><span style="color: #c678dd;">)</span> : center<span style="color: #c678dd;">(</span>center<span style="color: #c678dd;">)</span>, radius<span style="color: #c678dd;">(</span>r<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>;
  <span style="color: #c678dd;">sphere</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">center</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">shared_ptr</span><span style="color: #98be65;">&lt;</span>material<span style="color: #98be65;">&gt;</span> <span style="color: #dcaeea;">m</span><span style="color: #c678dd;">)</span> : center<span style="color: #c678dd;">(</span>center<span style="color: #c678dd;">)</span>, radius<span style="color: #c678dd;">(</span>r<span style="color: #c678dd;">)</span>, mat_ptr<span style="color: #c678dd;">(</span>m<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>;

  <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">hit</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_max</span>, <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">override</span>;

  <span style="color: #51afef;">public</span>:
    <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">center</span>;
    <span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>material<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">mat_ptr</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">radius</span>;
<span style="color: #51afef;">}</span>;

<span style="color: #ECBE7B;">bool</span> <span style="color: #a9a1e1;">sphere</span>::<span style="color: #c678dd;">hit</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp;<span style="color: #dcaeea;">r</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_min</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t_max</span>, <span style="color: #ECBE7B;">hit_record</span>&amp; <span style="color: #dcaeea;">rec</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">{</span>
  <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">org_min_c</span> = r.origin<span style="color: #c678dd;">()</span> - center;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">a</span> = dot<span style="color: #c678dd;">(</span>r.direction<span style="color: #98be65;">()</span>, r.direction<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">h_b</span> = dot<span style="color: #c678dd;">(</span>r.direction<span style="color: #98be65;">()</span>, org_min_c<span style="color: #c678dd;">)</span>;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">c</span> = dot<span style="color: #c678dd;">(</span>org_min_c, org_min_c<span style="color: #c678dd;">)</span> - radius*radius;
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">discriminant</span> = h_b*h_b - a*c;
  <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>discriminant &lt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>;
  <span style="color: #c678dd;">}</span> <span style="color: #51afef;">else</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">sqrtd</span> = <span style="color: #a9a1e1;">std</span>::sqrt<span style="color: #98be65;">(</span>discriminant<span style="color: #98be65;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">root</span> = <span style="color: #98be65;">(</span>-h_b - sqrtd<span style="color: #98be65;">)</span> / a;
    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>t_min &gt; root || t_max &lt; root<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      root = <span style="color: #a9a1e1;">(</span>-h_b + sqrtd<span style="color: #a9a1e1;">)</span> / a;
      <span style="color: #51afef;">if</span> <span style="color: #a9a1e1;">(</span>t_min &gt; root || t_max &lt; root<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>;
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span>
    rec.t = root;
    rec.point = r.at<span style="color: #98be65;">(</span>rec.t<span style="color: #98be65;">)</span>;
    rec.norm = unit_vector<span style="color: #98be65;">(</span>rec.point - center<span style="color: #98be65;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this will always be radius</span>
    rec.set_face_normal<span style="color: #98be65;">(</span>r, unit_vector<span style="color: #a9a1e1;">(</span>rec.point - center<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>;
    rec.mat_ptr = mat_ptr;

    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>;
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8c8ec6b" class="outline-3">
<h3 id="org8c8ec6b"><span class="section-number-3">7.2.</span> Modelling light scatter and reflectance</h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-org02a1198" class="outline-4">
<h4 id="org02a1198"><span class="section-number-4">7.2.1.</span> Lambertian Material</h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
Let&rsquo;s create our first material: Lambertian.
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">lambertian</span> : <span style="color: #51afef;">public</span> <span style="color: #ECBE7B;">material</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">lambertian</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">color</span> &amp;<span style="color: #dcaeea;">a</span><span style="color: #c678dd;">)</span> : albedo<span style="color: #c678dd;">(</span>a<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>

  <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">scatter</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">r_in</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hit_record</span> &amp;<span style="color: #dcaeea;">rec</span>,
                       <span style="color: #ECBE7B;">color</span> &amp;<span style="color: #dcaeea;">attenuation</span>, <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">scattered</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">override</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">scatter_direction</span> = rec.norm + random_unit_vector<span style="color: #98be65;">()</span>;
    scattered = ray<span style="color: #98be65;">(</span>rec.p, scatter_direction<span style="color: #98be65;">)</span>;
    attenuation = albedo;
    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>;
  <span style="color: #c678dd;">}</span>

<span style="color: #51afef;">public</span>:
  <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">albedo</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div>

<p>
This can be found in <code>material.h</code>.
Some questions:
</p>
<ul class="org-ul">
<li>why does the function <code>scatter</code> return a bool?</li>
<li>what does attenuation do? and why are we setting this to albedo?
Self Answer: I guess the parameters, <code>scattered</code> and <code>attenuation</code> are placeholders
to hold data returned from scatter, as the caller function will probably want to know
<ol class="org-ol">
<li>if we hit something</li>
<li>what color is the thing we hit</li>
<li>where does the ray bounce off to next</li>
</ol></li>
</ul>


<p>
There is something interesting that could happen in the above scatter function -
what would happen if the resultant <code>scatter_direction</code> is 0 (or close to)?
The book says that this is a problem, so we will intercept this issue.
</p>

<p>
First thing, let&rsquo;s create a convenient function in vec3 to check if a vector is close to
zero.
</p>

<p>
<b>vec3.h</b>
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">vec3</span> <span style="color: #51afef;">{</span>
    <span style="color: #c678dd;">...</span>
    <span style="color: #ECBE7B;">bool</span> near_zero<span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">const</span> <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">1e-8</span>;
      <span style="color: #51afef;">return</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">fabs</span><span style="color: #a9a1e1;">(</span><span style="color: #dcaeea;">e</span><span style="color: #51afef;">[</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #51afef;">]</span><span style="color: #a9a1e1;">)</span> &lt; s<span style="color: #98be65;">)</span> &amp;&amp; <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">fabs</span><span style="color: #a9a1e1;">(</span><span style="color: #dcaeea;">e</span><span style="color: #51afef;">[</span><span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">]</span><span style="color: #a9a1e1;">)</span> &lt; s<span style="color: #98be65;">)</span> &amp;&amp; <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">fabs</span><span style="color: #a9a1e1;">(</span><span style="color: #dcaeea;">e</span><span style="color: #51afef;">[</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #51afef;">]</span><span style="color: #a9a1e1;">)</span> &lt; s<span style="color: #98be65;">)</span>
    <span style="color: #c678dd;">}</span>
    <span style="color: #c678dd;">...</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>material.h</b>
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">scatter</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">r_in</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hit_record</span> &amp;<span style="color: #dcaeea;">rec</span>,
                       <span style="color: #ECBE7B;">color</span> &amp;<span style="color: #dcaeea;">attenuation</span>, <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">scattered</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">override</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">scatter_direction</span> = rec.norm + random_unit_vector<span style="color: #c678dd;">()</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>scatter_direction.near_zero<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      scatter_direction = rec.norm;
    <span style="color: #c678dd;">}</span>
    
    scattered = ray<span style="color: #c678dd;">(</span>rec.p, scatter_direction<span style="color: #c678dd;">)</span>;
    attenuation = albedo;
    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>;
  <span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org33a756f" class="outline-4">
<h4 id="org33a756f"><span class="section-number-4">7.2.2.</span> Metal Material</h4>
<div class="outline-text-4" id="text-7-2-2">
<p>
For metals, they also reflect.
How do you calculate the relfection off a surface given the incident ray and normal vector?
To get the direction, you can do \(v + 2b\), where \(b\) is \((v \cdot n) n\).
Why? We can use scalar projection to figure out what \(b\) is.
</p>

<p>
<b>vec3.h</b>
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">reflect</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #dcaeea;">incident</span>, <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #dcaeea;">norm</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">return</span> incident - <span style="color: #da8548; font-weight: bold;">2</span> * dot<span style="color: #c678dd;">(</span>incident, norm<span style="color: #c678dd;">)</span> * n;
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
Using this function, we can create our metal material.
<b>material.h</b>
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">metal</span> : <span style="color: #51afef;">public</span> <span style="color: #ECBE7B;">material</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">metal</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">color</span> &amp;<span style="color: #dcaeea;">a</span><span style="color: #c678dd;">)</span> : albedo<span style="color: #c678dd;">(</span>a<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>

  <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">scatter</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">r_in</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hit_record</span> &amp;<span style="color: #dcaeea;">rec</span>,
                       <span style="color: #ECBE7B;">color</span> &amp;<span style="color: #dcaeea;">attenuation</span>, <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">scattered</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">override</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">reflection_direction</span> =
        reflect<span style="color: #98be65;">(</span>unit_vector<span style="color: #a9a1e1;">(</span>r_in.direction<span style="color: #51afef;">()</span><span style="color: #a9a1e1;">)</span>, rec.norm<span style="color: #98be65;">)</span>;

    attenuation = albedo;
    scattered = ray<span style="color: #98be65;">(</span>rec.p, reflection_direction<span style="color: #98be65;">)</span>;
    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>;
  <span style="color: #c678dd;">}</span>

<span style="color: #51afef;">public</span>:
  <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">albedo</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge69a96c" class="outline-3">
<h3 id="orge69a96c"><span class="section-number-3">7.3.</span> A scene with metal spheres</h3>
<div class="outline-text-3" id="text-7-3">
<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org7836c5f"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add some materials</span>
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_center</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.3</span>, <span style="color: #da8548; font-weight: bold;">0.3</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_left</span>   = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_right</span>  = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.2</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_center<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_right<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>


<p>
<b>Output</b> <br />
The result are some shiny metal spheres, flanking a matte sphere.
</p>

<div id="orgf0e27f9" class="figure">
<p><img src="./images/four-materials.png" alt="four-materials.png" />
</p>
</div>


<p>
Aside: Why do these images look so grainy? Turns out the # of random samples per pixel
have something to do about this.
</p>

<div id="orgddc1b2f" class="figure">
<p><img src="./images/four-materials-hd.png" alt="four-materials-hd.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org1f75ddb" class="outline-3">
<h3 id="org1f75ddb"><span class="section-number-3">7.4.</span> Fuzzy Reflections</h3>
<div class="outline-text-3" id="text-7-4">
<p>
We can also randomize the reflection direction by using a small sphrere and choosing a new
endpoint for the ray.
</p>

<div class="org-src-container">
<pre class="src src-C++">  <span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">metal</span> : <span style="color: #51afef;">public</span> <span style="color: #ECBE7B;">material</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">public</span>:
    <span style="color: #c678dd;">metal</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">color</span> &amp;<span style="color: #dcaeea;">a</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">f</span><span style="color: #c678dd;">)</span> : albedo<span style="color: #c678dd;">(</span>a<span style="color: #c678dd;">)</span>, fuzz<span style="color: #c678dd;">(</span>f &lt; <span style="color: #da8548; font-weight: bold;">1</span> ? f : <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>

    <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">scatter</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">r_in</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hit_record</span> &amp;<span style="color: #dcaeea;">rec</span>,
                         <span style="color: #ECBE7B;">color</span> &amp;<span style="color: #dcaeea;">attenuation</span>, <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">scattered</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">override</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">reflection_direction</span> =
          reflect<span style="color: #98be65;">(</span>unit_vector<span style="color: #a9a1e1;">(</span>r_in.direction<span style="color: #51afef;">()</span><span style="color: #a9a1e1;">)</span>, rec.norm<span style="color: #98be65;">)</span>;

      attenuation = albedo;
      scattered = ray<span style="color: #98be65;">(</span>rec.point, reflection_direction + fuzz * random_unit_vector<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>;
      <span style="color: #51afef;">return</span> <span style="color: #98be65;">(</span>dot<span style="color: #a9a1e1;">(</span>scattered.direction<span style="color: #51afef;">()</span>, rec.norm<span style="color: #a9a1e1;">)</span> &gt; <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

  <span style="color: #51afef;">public</span>:
    <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">albedo</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">fuzz</span>;
  <span style="color: #51afef;">}</span>;
</pre>
</div>

<p>
Let&rsquo;s add some fuzziness to the world.
</p>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="orgd6b48d3"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">1000</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add some materials</span>
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_center</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.3</span>, <span style="color: #da8548; font-weight: bold;">0.3</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_left</span>   = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">0.2</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_right</span>  = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.2</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;

     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_center<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_right<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b>
</p>

<div id="org7c43a2d" class="figure">
<p><img src="./images/four-materials-fuzz.png" alt="four-materials-fuzz.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org39111fd" class="outline-2">
<h2 id="org39111fd"><span class="section-number-2">8.</span> Dielectrics</h2>
<div class="outline-text-2" id="text-8">
<p>
Clear materials are called dielectrics. When a light ray hits them, it splits into a reflected ray
and a refracted ray. The way that this will be handled is that we will choose
randomly whether the ray is reflected or refracted.
</p>
</div>
<div id="outline-container-org21d2dff" class="outline-3">
<h3 id="org21d2dff"><span class="section-number-3">8.1.</span> Refraction</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Refraction is defined by Snell&rsquo;s law:
</p>
\begin{align*}
\eta \cdot \sin \theta = \eta' \cdot \sin \theta'
\end{align*}

<p>
Where \(\theta\) and \(\theta'\) are the angles from the normal, and \(\eta\) and \(\eta'\) are
refractive indices (where air is \(1.0\), \(\text{glass}=1.3-1.7\), and \(\text{diamond} = 2.4\).
For more visual learners, a diagram from <a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html#dielectrics">the textbook</a>.
</p>

<p>
To get the direction of the reflected ray, we need to get \(\theta'\).
</p>
\begin{align*}
\sin\theta' &= \frac{\eta}{\eta'}\cdot \sin\theta
\end{align*}

<p>
I did some reading into <a href="https://www.wikiwand.com/en/Snell's_law">Snell&rsquo;s law</a>, and the equations they used are different to
those used in the book. I&rsquo;ll stick to the equations derived here:
</p>
\begin{align*}
\mathbf{R}'_{\perp} &= \frac{\eta}{\eta'}\left(R + (-R \cdot n)n\right) \\
\mathbf{R}'_{\parallel} &= -\sqrt{1 - |\mathbf{R}'_{\perp}|^2} \cdot n \\
\end{align*}

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">refract</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #dcaeea;">uv</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">vec3</span>&amp; <span style="color: #dcaeea;">n</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">eta_i_over_eta_t</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">r_out_perp</span> = eta_i_over_eta_t * <span style="color: #c678dd;">(</span>uv + fmin<span style="color: #98be65;">(</span>dot<span style="color: #a9a1e1;">(</span>-uv, n<span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #98be65;">)</span> * n<span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">r_out_para</span> = -sqrt<span style="color: #c678dd;">(</span>fabs<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">1.0</span> - r_out_perp.length_squared<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> * n;
    <span style="color: #51afef;">return</span> r_out_perp + r_out_para;
  <span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge7c38f2" class="outline-3">
<h3 id="orge7c38f2"><span class="section-number-3">8.2.</span> Total Internal reflection</h3>
<div class="outline-text-3" id="text-8-2">
<p>
According to snell&rsquo;s law, we have
</p>
\begin{align*}
\sin \theta' = \frac{\eta}{\eta'} \cdot \sin \theta
\end{align*}
<p>
But if the ray is inside glass and outside is air: (\(\eta = 1.5\) and \(\eta' = 1.0\))
</p>
\begin{align*}
\sin \theta' = \frac{1.5}{1.0} \cdot \sin \theta
\end{align*}
<p>
We realize that for certain values of \(\theta\), \(\sin \theta'\) will have to
nnnnequal a value greater than one. This is where the equation breaks down.
In this case, a solution cannot exist and therefore the ray is reflected instead of
refracted.
</p>

<p>
Let&rsquo;s create our material.
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">dielectric</span> : <span style="color: #51afef;">public</span> <span style="color: #ECBE7B;">material</span> <span style="color: #51afef;">{</span>
 <span style="color: #51afef;">public</span>:
 <span style="color: #c678dd;">dielectric</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">index_of_refraction</span><span style="color: #c678dd;">)</span> : ir<span style="color: #c678dd;">(</span>index_of_refraction<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>

  <span style="color: #51afef;">virtual</span> <span style="color: #ECBE7B;">bool</span> <span style="color: #c678dd;">scatter</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span> &amp;<span style="color: #dcaeea;">r_in</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hit_record</span> &amp;<span style="color: #dcaeea;">rec</span>, <span style="color: #ECBE7B;">color</span> &amp;<span style="color: #dcaeea;">attenuation</span>, <span style="color: #ECBE7B;">ray</span>&amp;<span style="color: #dcaeea;">scattered</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    attenuation = color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">refraction_ratio</span> = rec.front_face ? <span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">1.0</span>/ir<span style="color: #98be65;">)</span> : ir; <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">unit_dir</span> = unit_vector<span style="color: #98be65;">(</span>r_in.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">cos_theta</span> = fmin<span style="color: #98be65;">(</span>dot<span style="color: #a9a1e1;">(</span>-unit_dir, rec.norm<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">sin_theta</span> = sqrt<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">1.0</span> - cos_theta * cos_theta<span style="color: #98be65;">)</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if you cannot refract</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">direction</span>;
    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>refraction_ratio * sin_theta &gt; <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      direction = reflect<span style="color: #a9a1e1;">(</span>unit_dir, rec.norm<span style="color: #a9a1e1;">)</span>;
    <span style="color: #98be65;">}</span> <span style="color: #51afef;">else</span> <span style="color: #98be65;">{</span>
      direction = refract<span style="color: #a9a1e1;">(</span>unit_dir, rec.norm, refraction_ratio<span style="color: #a9a1e1;">)</span>;
    <span style="color: #98be65;">}</span> 

    scattered = ray<span style="color: #98be65;">(</span>rec.point, direction<span style="color: #98be65;">)</span>;
    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>;
  <span style="color: #c678dd;">}</span>

 <span style="color: #51afef;">public</span>:
  <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">ir</span>;
<span style="color: #51afef;">}</span>;

</pre>
</div>
</div>
</div>
<div id="outline-container-org34814fb" class="outline-3">
<h3 id="org34814fb"><span class="section-number-3">8.3.</span> Schlick approximation</h3>
<div class="outline-text-3" id="text-8-3">
<p>
Real glass has reflectivity that varies with angle - it becomes more reflective the steeper the angle.
There is a very nice approximation called the Schlick Approxiimation, which yields:
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">dielectric</span> : <span style="color: #51afef;">public</span> <span style="color: #ECBE7B;">material</span> <span style="color: #51afef;">{</span>
    <span style="color: #c678dd;">...</span>
    <span style="color: #51afef;">private</span>:
    <span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">double</span> <span style="color: #c678dd;">reflectance</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">cosine</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">ref_indx</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use schlick approximation for reflectance</span>
      <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">r0</span> = <span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - ref_indx<span style="color: #98be65;">)</span> / <span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">1</span> + ref_indx<span style="color: #98be65;">)</span>;
      r0 = r0 * r0;
      <span style="color: #51afef;">return</span> r0 + <span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">1</span>-r0<span style="color: #98be65;">)</span> * pow<span style="color: #98be65;">(</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - cosine<span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">5</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>;
</pre>
</div>

<p>
Let&rsquo;s see this in action
</p>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="orgf764e60"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add some materials</span>
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_center</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.3</span>, <span style="color: #da8548; font-weight: bold;">0.3</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_left</span>   = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.7</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_right</span>  = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.2</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;

     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_center<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_right<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b>
</p>

<div id="org67e3e09" class="figure">
<p><img src="./images/four-materials-solid-glass.png" alt="four-materials-solid-glass.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgf87da5f" class="outline-3">
<h3 id="orgf87da5f"><span class="section-number-3">8.4.</span> Hollow Glass Sphere</h3>
<div class="outline-text-3" id="text-8-4">
<p>
You can give a negative radius to a sphere to create a &ldquo;bubble&rdquo;, as in a hollow glass
sphere (this takes advantage of normalizing the normal by dividing by radius, which can be
positive or negative. This doesn&rsquo;t work if you set the face normal using the <code>unit_vector</code> function.)
</p>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org848889a"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add some materials</span>
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_center</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.3</span>, <span style="color: #da8548; font-weight: bold;">0.3</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_left</span>   = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.5</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_right</span>  = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.2</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;

     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_center<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, -<span style="color: #da8548; font-weight: bold;">0.4</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_right<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>


<div id="orgb4feb07" class="figure">
<p><img src="./images/four-materials-hollow-glass.png" alt="four-materials-hollow-glass.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb9292f8" class="outline-2">
<h2 id="orgb9292f8"><span class="section-number-2">9.</span> Positionable Camera</h2>
<div class="outline-text-2" id="text-9">
<p>
Camera time! There are a few things we want to adjust with the camera.
Since cameras are apparently a PITA to debug, it will be completed incrementally.
</p>
</div>
<div id="outline-container-orgcaaa401" class="outline-3">
<h3 id="orgcaaa401"><span class="section-number-3">9.1.</span> Camera Viewing Geometry</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Let the camera take a <code>theta</code> (\(\theta\)), which represents the vertical viewing angle.
If <code>h</code> represents the height from the horizontal to the top, then \(h = \tan(\frac{\theta}{2})\).
That means, the viewport height would be <code>h * 2.0</code>.
</p>

<p>
Implementing this into the camera:
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #c678dd;">camera</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vfov</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">vertical FOV in degrees</span>
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">theta</span> = degrees_to_radians<span style="color: #c678dd;">(</span>vfov<span style="color: #c678dd;">)</span>;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_height</span> = <span style="color: #da8548; font-weight: bold;">2.0</span> * tan<span style="color: #c678dd;">(</span>theta / <span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">)</span>;

      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_width</span> = vp_height * aspect;
      <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focal_length</span> = <span style="color: #da8548; font-weight: bold;">1.0</span>;

      origin = vec3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
      horizontal = vec3<span style="color: #c678dd;">(</span>vp_width, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
      vertical = vec3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, vp_height, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
      lower_left =
          origin - horizontal / <span style="color: #da8548; font-weight: bold;">2</span> - vertical / <span style="color: #da8548; font-weight: bold;">2</span> - vec3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, focal_length<span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4abfd9e" class="outline-3">
<h3 id="org4abfd9e"><span class="section-number-3">9.2.</span> Positioning of Camera</h3>
<div class="outline-text-3" id="text-9-2">
<p>
To get an arbitrary viewpoint, then there are two points of interest: The <code>lookfrom</code>, and the <code>lookat</code>.
This will get the camera to look at the right place.
How do you define rotation for the camera then?
We define a &ldquo;view up&rdquo; vector, which the camera rotates around.
</p>

<p>
Let&rsquo;s look at this in <code>camera.h</code>.
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #c678dd;">camera</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookfrom</span>, <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookat</span>, <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">vup</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vfov</span>,
         <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">vertical FOV in degrees</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">theta</span> = degrees_to_radians<span style="color: #c678dd;">(</span>vfov<span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_height</span> = <span style="color: #da8548; font-weight: bold;">2.0</span> * tan<span style="color: #c678dd;">(</span>theta / <span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">)</span>;

    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_width</span> = vp_height * aspect;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">these three vectors describe the orientation of the camera</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">w</span> = unit_vector<span style="color: #c678dd;">(</span>lookfrom - lookat<span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">u</span> = unit_vector<span style="color: #c678dd;">(</span>cross<span style="color: #98be65;">(</span>vup, w<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">v</span> = cross<span style="color: #c678dd;">(</span>w, u<span style="color: #c678dd;">)</span>;

    origin = lookfrom;
    horizontal = vp_width * u; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">multiplying by u gets the correct horizontal vector</span>
    vertical = vp_height * v;

    lower_left = origin - w - horizontal / <span style="color: #da8548; font-weight: bold;">2</span> - vertical / <span style="color: #da8548; font-weight: bold;">2</span>;
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
Let&rsquo;s try this new camera on our previous scene.
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="orgc1bb085"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add some materials</span>
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_center</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.3</span>, <span style="color: #da8548; font-weight: bold;">0.3</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_left</span>   = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.5</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_right</span>  = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.2</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;

     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_center<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, -<span style="color: #da8548; font-weight: bold;">0.4</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_right<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookfrom</span><span style="color: #c678dd;">(</span>-<span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookat</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">world_up</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
   
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span><span style="color: #c678dd;">(</span>lookfrom, lookat, world_up, <span style="color: #da8548; font-weight: bold;">90</span>, aspect<span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b>
</p>

<div id="org8afd82f" class="figure">
<p><img src="./images/four-mat-moveable-cam.png" alt="four-mat-moveable-cam.png" />
</p>
</div>

<p>
We can also change the FOV to get something different:
</p>
<div class="org-src-container">
<pre class="src src-C++">  <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span><span style="color: #51afef;">(</span>lookfrom, lookat, world_up, <span style="color: #da8548; font-weight: bold;">20</span>, aspect<span style="color: #51afef;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-C++" id="org6a3dce2"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add some materials</span>
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_center</span> = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.3</span>, <span style="color: #da8548; font-weight: bold;">0.3</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">0.1</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_left</span>   = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.5</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_right</span>  = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.2</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;

     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_center<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, -<span style="color: #da8548; font-weight: bold;">0.4</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_right<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookfrom</span><span style="color: #c678dd;">(</span>-<span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookat</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">world_up</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
   
     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span><span style="color: #c678dd;">(</span>lookfrom, lookat, world_up, <span style="color: #da8548; font-weight: bold;">20</span>, aspect<span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>


<div id="org60fb1a7" class="figure">
<p><img src="./images/four-mat-moveable-cam-fov20.png" alt="four-mat-moveable-cam-fov20.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc94f8a0" class="outline-2">
<h2 id="orgc94f8a0"><span class="section-number-2">10.</span> Depth of Field (Defocus Blur)</h2>
<div class="outline-text-2" id="text-10">
<p>
The reason for depth of field is that in real cameras, they have a big sensor
to capture light, rather than a pinhole. Thus, for a camera to work, they need
to bend the rays that converge to a point away and spread across the sensor.
A way to think about this: A point from the plane of focus maps to a point on the sensor.
</p>

<p>
The distance between the projection point and the plane of focus the <i>focus distance</i>.
<b>NOTE: This is not to be confused with focal length - which is the distance between the</b>
<b>projection point and the image plane</b> (This determines what is shown on camera, rather than what is <i>in focus</i> on camera).
</p>
</div>
<div id="outline-container-org2a2be46" class="outline-3">
<h3 id="org2a2be46"><span class="section-number-3">10.1.</span> Thin lens approximation</h3>
<div class="outline-text-3" id="text-10-1">
<p>
It would be cool to simulate how a camera lens works, but that would be too much work.
So, we use a thin lens approximation:
We just point our rays at the focus plane, where everything is in perfect focus.
</p>
</div>
</div>
<div id="outline-container-orgf9358db" class="outline-3">
<h3 id="orgf9358db"><span class="section-number-3">10.2.</span> Generating sample rays</h3>
<div class="outline-text-3" id="text-10-2">
<p>
If we move our origin around, we would get a blur effect happening for anything our ray hits
that is not on the plane of focus (as the rays would diverge).
</p>

<p>
So, what we do is we generate random scene rays originating from a disk centered at
<code>lookfrom</code>. The larger the radius, the more it punishes anything out of the plane
of focus (more blur).
</p>

<p>
Implementing this, we create a utility function in <code>vec3.h</code>.
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #ECBE7B;">vec3</span> <span style="color: #c678dd;">random_in_unit_disk</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">while</span> <span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">true</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">p</span> = vec3<span style="color: #98be65;">(</span>random_double<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, random_double<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>p.length_squared<span style="color: #a9a1e1;">()</span> &lt;= <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #98be65;">)</span> <span style="color: #51afef;">return</span> p;
    <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
As for <code>camera.h</code>:
</p>
<div class="org-src-container">
<pre class="src src-c++">  <span style="color: #c678dd;">camera</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookfrom</span>, <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookat</span>, <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">vup</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vfov</span>,
         <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aperture</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focus_dist</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">vertical FOV in degrees</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">theta</span> = deg_to_rad<span style="color: #c678dd;">(</span>vfov<span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_height</span> = <span style="color: #da8548; font-weight: bold;">2.0</span> * tan<span style="color: #c678dd;">(</span>theta / <span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">)</span>;

    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">vp_width</span> = vp_height * aspect; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">these three vectors describe the orientation of the camera</span>
    w = unit_vector<span style="color: #c678dd;">(</span>lookfrom - lookat<span style="color: #c678dd;">)</span>;
    u = unit_vector<span style="color: #c678dd;">(</span>cross<span style="color: #98be65;">(</span>vup, w<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
    v = cross<span style="color: #c678dd;">(</span>w, u<span style="color: #c678dd;">)</span>;

    origin = lookfrom;
    horizontal = vp_width * u; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">multiplying by u gets the correct horizontal vector</span>
    vertical = vp_height * v;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">change the horizontal and vertical with consideration of focus distance</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">change the lower left based on where the focus dist is</span>
    horizontal *= focus_dist;
    vertical *= focus_dist;
    lower_left = origin - w * focus_dist - horizontal / <span style="color: #da8548; font-weight: bold;">2</span> - vertical / <span style="color: #da8548; font-weight: bold;">2</span>;

    lens_radius = aperture / <span style="color: #da8548; font-weight: bold;">2</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">ray</span> <span style="color: #c678dd;">get_ray_blur</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">s</span>, <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">t</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">random point on lens radius</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">rd</span> = lens_radius * random_in_unit_disk<span style="color: #c678dd;">()</span>;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">orient lens radius on uv plane.</span>
    <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">offset</span> = u * rd.x<span style="color: #c678dd;">()</span> + v * rd.y<span style="color: #c678dd;">()</span>;

    <span style="color: #51afef;">return</span> ray<span style="color: #c678dd;">(</span>origin + offset, lower_left + horizontal * s + vertical * t - <span style="color: #98be65;">(</span>origin + offset<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
Let&rsquo;s see this in action.
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org01e651b"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">16.0</span> / <span style="color: #da8548; font-weight: bold;">9.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">600</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">100</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add some materials</span>
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_center</span> = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.3</span>, <span style="color: #da8548; font-weight: bold;">0.3</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">0.1</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_left</span>   = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.5</span><span style="color: #c678dd;">)</span>;
     <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_right</span>  = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.8</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.2</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;

     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">100.5</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">100</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_center<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, -<span style="color: #da8548; font-weight: bold;">0.4</span>, material_left<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
     world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, material_right<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookfrom</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">3</span>, <span style="color: #da8548; font-weight: bold;">3</span>, <span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookat</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">world_up</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">set the focus distance to where lookat is.</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focus_distance</span> = <span style="color: #c678dd;">(</span>lookfrom - lookat<span style="color: #c678dd;">)</span>.length<span style="color: #c678dd;">()</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aperture</span> = <span style="color: #da8548; font-weight: bold;">2.0</span>;

     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span><span style="color: #c678dd;">(</span>lookfrom, lookat, world_up, <span style="color: #da8548; font-weight: bold;">20</span>, aspect, aperture, focus_distance<span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray_blur<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b> <br />
This looks a bit sketchy, but that&rsquo;s because we aren&rsquo;t sending enough rays out there.
</p>

<div id="orgc970b20" class="figure">
<p><img src="./images/four-mat-move-dof-cam.png" alt="four-mat-move-dof-cam.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orga917042" class="outline-2">
<h2 id="orga917042"><span class="section-number-2">11.</span> The Finale</h2>
<div class="outline-text-2" id="text-11">
<p>
We have made it to the end, where we will create a scene with a bunch of random spheres
on the ground, as well as 3 large spheres in the center.
</p>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org208819b"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #c678dd;">random_scene</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">generate the ground first.</span>
    <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1000</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1000</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">generate all the random spheres</span>
    <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">a</span> = -<span style="color: #da8548; font-weight: bold;">11</span>; a &lt; <span style="color: #da8548; font-weight: bold;">11</span>; ++a<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">b</span> = -<span style="color: #da8548; font-weight: bold;">11</span>; b &lt; <span style="color: #da8548; font-weight: bold;">11</span>; ++b<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">choose_mat</span> = random_double<span style="color: #a9a1e1;">()</span>;
        <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">radius</span> = <span style="color: #da8548; font-weight: bold;">0.2</span>;
        <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">center</span><span style="color: #a9a1e1;">(</span>a + <span style="color: #da8548; font-weight: bold;">0.9</span> * random_double<span style="color: #51afef;">()</span>, <span style="color: #da8548; font-weight: bold;">0.2</span>, b + <span style="color: #da8548; font-weight: bold;">0.9</span> * random_double<span style="color: #51afef;">()</span><span style="color: #a9a1e1;">)</span>;

        <span style="color: #51afef;">if</span> <span style="color: #a9a1e1;">(</span><span style="color: #51afef;">(</span>center - point3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">4</span>, <span style="color: #da8548; font-weight: bold;">0.2</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>.length<span style="color: #51afef;">()</span> &gt; <span style="color: #da8548; font-weight: bold;">0.9</span><span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
          <span style="color: #ECBE7B;">shared_ptr</span><span style="color: #51afef;">&lt;</span>material<span style="color: #51afef;">&gt;</span> <span style="color: #dcaeea;">sphere_material</span>;
        
          <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>choose_mat &lt; <span style="color: #da8548; font-weight: bold;">0.8</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">diffuse</span>
            <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">albedo</span> = <span style="color: #a9a1e1;">color</span>::random<span style="color: #c678dd;">()</span> * <span style="color: #a9a1e1;">color</span>::random<span style="color: #c678dd;">()</span>;
            sphere_material = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>albedo<span style="color: #c678dd;">)</span>;
            world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>center, radius, sphere_material<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
          <span style="color: #51afef;">}</span> <span style="color: #51afef;">else</span> <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>choose_mat &lt; <span style="color: #da8548; font-weight: bold;">0.95</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">metal</span>
            <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">albedo</span> = <span style="color: #a9a1e1;">color</span>::random<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
            <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">fuzz</span> = random_double<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #c678dd;">)</span>;
            sphere_material = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>albedo, fuzz<span style="color: #c678dd;">)</span>;
            world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>center, radius, sphere_material<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
          <span style="color: #51afef;">}</span> <span style="color: #51afef;">else</span> <span style="color: #51afef;">{</span>
            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">glass</span>
            sphere_material = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.5</span><span style="color: #c678dd;">)</span>;
            world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>center, radius, sphere_material<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
          <span style="color: #51afef;">}</span>
        <span style="color: #a9a1e1;">}</span>
      <span style="color: #98be65;">}</span>
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material1</span> = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.5</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, material1<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
  
    <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material2</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.4</span>, <span style="color: #da8548; font-weight: bold;">0.2</span>, <span style="color: #da8548; font-weight: bold;">0.1</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">4</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, material2<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
  
    <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material3</span> = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">4</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, material3<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
  
    <span style="color: #51afef;">return</span> world;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">3.0</span> / <span style="color: #da8548; font-weight: bold;">2.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">400</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">3</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span> = random_scene<span style="color: #c678dd;">()</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookfrom</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">13</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookat</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">world_up</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">set the focus distance to where lookat is.</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focus_distance</span> = <span style="color: #da8548; font-weight: bold;">10.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aperture</span> = <span style="color: #da8548; font-weight: bold;">0.1</span>;

     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span><span style="color: #c678dd;">(</span>lookfrom, lookat, world_up, <span style="color: #da8548; font-weight: bold;">20</span>, aspect, aperture, focus_distance<span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
         <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
         <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
         <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
           <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
           temp += ray_color<span style="color: #51afef;">(</span>cam.get_ray_blur<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, world, max_depth<span style="color: #51afef;">)</span>;
         <span style="color: #a9a1e1;">}</span>
         write_color_gamma<span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">std</span>::cout, temp, samples_per_px<span style="color: #a9a1e1;">)</span>;
       <span style="color: #98be65;">}</span>
     <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b> <br />
This looks very bad. However, the code is running too slow for me to be patient with this.
</p>

<div id="org017b517" class="figure">
<p><img src="./images/finale-rt-1.png" alt="finale-rt-1.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgc0f50c8" class="outline-2">
<h2 id="orgc0f50c8"><span class="section-number-2">12.</span> Multithreading</h2>
<div class="outline-text-2" id="text-12">
<p>
I will attempt the render above with a multithreaded approach.
</p>

<p>
<b>Source</b>
</p>
<div class="org-src-container">
<pre class="src src-C++" id="org069cd37"><span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/rtweekend.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/color.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/hittable_list.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/sphere.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/camera.h"</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #98be65;">"util/material.h"</span>

<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">thread</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">mutex</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">  #include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">chrono</span><span style="color: #51afef;">&gt;</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">give it a ray and an object and it'll tell you what to color it</span>
  <span style="color: #ECBE7B;">color</span> <span style="color: #c678dd;">ray_color</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">ray</span>&amp; <span style="color: #dcaeea;">r</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">hittable</span>&amp; <span style="color: #dcaeea;">world</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">depth</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hit_record</span> <span style="color: #dcaeea;">rec</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>depth &lt;= <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">return</span> color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>world.hit<span style="color: #98be65;">(</span>r, <span style="color: #da8548; font-weight: bold;">0.0001</span>, infinity, rec<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #ECBE7B;">ray</span> <span style="color: #dcaeea;">scattered</span>;
      <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">attenuation</span>;

      <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>rec.mat_ptr-&gt;scatter<span style="color: #a9a1e1;">(</span>r, rec, attenuation, scattered<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #51afef;">return</span> attenuation * ray_color<span style="color: #a9a1e1;">(</span>scattered, world, depth -<span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>

      <span style="color: #51afef;">return</span> color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise, return sky gradient</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">blue_portion</span> = <span style="color: #da8548; font-weight: bold;">0.5</span> * <span style="color: #c678dd;">(</span>unit_vector<span style="color: #98be65;">(</span>r.direction<span style="color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>.y<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span>;
    <span style="color: #51afef;">return</span> blue_portion * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">1.0</span><span style="color: #c678dd;">)</span> +
            <span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span> - blue_portion<span style="color: #c678dd;">)</span> * color<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #c678dd;">random_scene</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">generate the ground first.</span>
    <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material_ground</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, -<span style="color: #da8548; font-weight: bold;">1000</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1000</span>, material_ground<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">generate all the random spheres</span>
    <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">a</span> = -<span style="color: #da8548; font-weight: bold;">11</span>; a &lt; <span style="color: #da8548; font-weight: bold;">11</span>; ++a<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">b</span> = -<span style="color: #da8548; font-weight: bold;">11</span>; b &lt; <span style="color: #da8548; font-weight: bold;">11</span>; ++b<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">choose_mat</span> = random_double<span style="color: #a9a1e1;">()</span>;
        <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">radius</span> = <span style="color: #da8548; font-weight: bold;">0.2</span>;
        <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">center</span><span style="color: #a9a1e1;">(</span>a + <span style="color: #da8548; font-weight: bold;">0.9</span> * random_double<span style="color: #51afef;">()</span>, <span style="color: #da8548; font-weight: bold;">0.2</span>, b + <span style="color: #da8548; font-weight: bold;">0.9</span> * random_double<span style="color: #51afef;">()</span><span style="color: #a9a1e1;">)</span>;

        <span style="color: #51afef;">if</span> <span style="color: #a9a1e1;">(</span><span style="color: #51afef;">(</span>center - point3<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">4</span>, <span style="color: #da8548; font-weight: bold;">0.2</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>.length<span style="color: #51afef;">()</span> &gt; <span style="color: #da8548; font-weight: bold;">0.9</span><span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
          <span style="color: #ECBE7B;">shared_ptr</span><span style="color: #51afef;">&lt;</span>material<span style="color: #51afef;">&gt;</span> <span style="color: #dcaeea;">sphere_material</span>;

          <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>choose_mat &lt; <span style="color: #da8548; font-weight: bold;">0.8</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">diffuse</span>
            <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">albedo</span> = <span style="color: #a9a1e1;">color</span>::random<span style="color: #c678dd;">()</span> * <span style="color: #a9a1e1;">color</span>::random<span style="color: #c678dd;">()</span>;
            sphere_material = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>albedo<span style="color: #c678dd;">)</span>;
            world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>center, radius, sphere_material<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
          <span style="color: #51afef;">}</span> <span style="color: #51afef;">else</span> <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>choose_mat &lt; <span style="color: #da8548; font-weight: bold;">0.95</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">metal</span>
            <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">albedo</span> = <span style="color: #a9a1e1;">color</span>::random<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #c678dd;">)</span>;
            <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">fuzz</span> = random_double<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #c678dd;">)</span>;
            sphere_material = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>albedo, fuzz<span style="color: #c678dd;">)</span>;
            world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>center, radius, sphere_material<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
          <span style="color: #51afef;">}</span> <span style="color: #51afef;">else</span> <span style="color: #51afef;">{</span>
            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">glass</span>
            sphere_material = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.5</span><span style="color: #c678dd;">)</span>;
            world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>center, radius, sphere_material<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
          <span style="color: #51afef;">}</span>
        <span style="color: #a9a1e1;">}</span>
      <span style="color: #98be65;">}</span>
    <span style="color: #c678dd;">}</span>

    <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material1</span> = make_shared<span style="color: #c678dd;">&lt;</span>dielectric<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">1.5</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, material1<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material2</span> = make_shared<span style="color: #c678dd;">&lt;</span>lambertian<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.4</span>, <span style="color: #da8548; font-weight: bold;">0.2</span>, <span style="color: #da8548; font-weight: bold;">0.1</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span>-<span style="color: #da8548; font-weight: bold;">4</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, material2<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">material3</span> = make_shared<span style="color: #c678dd;">&lt;</span>metal<span style="color: #c678dd;">&gt;(</span>color<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0.7</span>, <span style="color: #da8548; font-weight: bold;">0.6</span>, <span style="color: #da8548; font-weight: bold;">0.5</span><span style="color: #98be65;">)</span>, <span style="color: #da8548; font-weight: bold;">0.0</span><span style="color: #c678dd;">)</span>;
    world.add<span style="color: #c678dd;">(</span>make_shared<span style="color: #98be65;">&lt;</span>sphere<span style="color: #98be65;">&gt;(</span>point3<span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">4</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, material3<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

    <span style="color: #51afef;">return</span> world;
  <span style="color: #51afef;">}</span>

  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">color</span><span style="color: #51afef;">&gt;</span> <span style="color: #dcaeea;">output</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">mutex</span> <span style="color: #dcaeea;">output_lock</span>;

  <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">tracing_properties</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span>;
    <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span>;
    <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">max_depth</span>;
    <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span>;
    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span>;
  <span style="color: #51afef;">}</span>;

  <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">trace_image</span><span style="color: #51afef;">(</span><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">tracing_properties</span> &amp;<span style="color: #dcaeea;">prop</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    srand<span style="color: #c678dd;">(</span><span style="color: #98be65;">(</span><span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">int</span><span style="color: #98be65;">)</span>time<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">does the computation</span>
    <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">color</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">local_result</span><span style="color: #c678dd;">{}</span>;
    <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">j</span>=prop.img_height - <span style="color: #da8548; font-weight: bold;">1</span>; j &gt;= <span style="color: #da8548; font-weight: bold;">0</span>; --j<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; prop.img_width; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">do stuff</span>
        <span style="color: #ECBE7B;">color</span> <span style="color: #dcaeea;">temp</span><span style="color: #a9a1e1;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #a9a1e1;">)</span>;
        <span style="color: #51afef;">for</span> <span style="color: #a9a1e1;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">s</span> = <span style="color: #da8548; font-weight: bold;">0</span>; s &lt; prop.samples_per_px; ++s<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
          <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only sample [0, 1) + pixel. If that pixel is half hit half not, then it is blurred.</span>
          <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">u</span> = <span style="color: #51afef;">(</span>i + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>prop.img_width - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
          <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">v</span> = <span style="color: #51afef;">(</span>j + random_double<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> / <span style="color: #51afef;">(</span>prop.img_height - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">)</span>;
          temp += ray_color<span style="color: #51afef;">(</span>prop.cam.get_ray_blur<span style="color: #c678dd;">(</span>u, v<span style="color: #c678dd;">)</span>, prop.world, prop.max_depth<span style="color: #51afef;">)</span>;
        <span style="color: #a9a1e1;">}</span>
        local_result.push_back<span style="color: #a9a1e1;">(</span>temp<span style="color: #a9a1e1;">)</span>;
      <span style="color: #98be65;">}</span>
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">writes to the mutex</span>
    output_lock.lock<span style="color: #c678dd;">()</span>;
    <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>output.size<span style="color: #98be65;">()</span> == <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      output = local_result;
    <span style="color: #c678dd;">}</span> <span style="color: #51afef;">else</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; local_result.size<span style="color: #a9a1e1;">()</span>; ++i<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
          output<span style="color: #a9a1e1;">[</span>i<span style="color: #a9a1e1;">]</span> += local_result<span style="color: #a9a1e1;">[</span>i<span style="color: #a9a1e1;">]</span>;
      <span style="color: #98be65;">}</span>
    <span style="color: #c678dd;">}</span>
    output_lock.unlock<span style="color: #c678dd;">()</span>;
  <span style="color: #51afef;">}</span>

  <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Image</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aspect</span> = <span style="color: #da8548; font-weight: bold;">3.0</span> / <span style="color: #da8548; font-weight: bold;">2.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_width</span> = <span style="color: #da8548; font-weight: bold;">800</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">img_height</span> = <span style="color: #51afef;">static_cast</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span>img_width / aspect<span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px</span> = <span style="color: #da8548; font-weight: bold;">30</span>;

     <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">max_depth</span> = <span style="color: #da8548; font-weight: bold;">50</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">world</span>
     <span style="color: #ECBE7B;">hittable_list</span> <span style="color: #dcaeea;">world</span> = random_scene<span style="color: #c678dd;">()</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">camera</span>
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookfrom</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">13</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">point3</span> <span style="color: #dcaeea;">lookat</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;
     <span style="color: #ECBE7B;">vec3</span> <span style="color: #dcaeea;">world_up</span><span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">set the focus distance to where lookat is.</span>
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">focus_distance</span> = <span style="color: #da8548; font-weight: bold;">10.0</span>;
     <span style="color: #ECBE7B;">double</span> <span style="color: #dcaeea;">aperture</span> = <span style="color: #da8548; font-weight: bold;">0.1</span>;

     <span style="color: #ECBE7B;">camera</span> <span style="color: #dcaeea;">cam</span><span style="color: #c678dd;">(</span>lookfrom, lookat, world_up, <span style="color: #da8548; font-weight: bold;">20</span>, aspect, aperture, focus_distance<span style="color: #c678dd;">)</span>;

     <span style="color: #5B6268;">// </span><span style="color: #5B6268;">render</span>
     <span style="color: #ECBE7B;">tracing_properties</span> <span style="color: #dcaeea;">props</span> = <span style="color: #c678dd;">{</span>
       img_height,
       img_width,
       world,
       max_depth,
       cam,
       samples_per_px
     <span style="color: #c678dd;">}</span>;

     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">num_threads</span> = <span style="color: #da8548; font-weight: bold;">16</span>;
     <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">samples_per_px_global</span> = samples_per_px * num_threads;

     <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span><span style="color: #c678dd;">&lt;</span><span style="color: #a9a1e1;">std</span>::thread<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">threads</span>;
     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; num_threads; ++i<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       threads.emplace_back<span style="color: #98be65;">(</span>trace_image, <span style="color: #a9a1e1;">std</span>::ref<span style="color: #a9a1e1;">(</span>props<span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>;
     <span style="color: #c678dd;">}</span>

     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; num_threads; ++i<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       threads<span style="color: #98be65;">[</span>i<span style="color: #98be65;">]</span>.join<span style="color: #98be65;">()</span>;
     <span style="color: #c678dd;">}</span>

     <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"P3\n"</span> &lt;&lt; img_width &lt;&lt; <span style="color: #98be65;">" "</span> &lt;&lt; img_height &lt;&lt; <span style="color: #98be65;">"\n255\n"</span>;

     output_lock.lock<span style="color: #c678dd;">()</span>;
     <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #51afef;">auto</span> &amp;<span style="color: #dcaeea;">c</span> : output<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
       write_color_gamma<span style="color: #98be65;">(</span><span style="color: #a9a1e1;">std</span>::cout, c, samples_per_px_global<span style="color: #98be65;">)</span>;
     <span style="color: #c678dd;">}</span>
     output_lock.unlock<span style="color: #c678dd;">()</span>;

  <span style="color: #51afef;">}</span>
</pre>
</div>

<p>
<b>Output</b><br />
This took 1000 seconds to run! Imagine doing this without multithreading.
</p>


<div id="org8bbf86a" class="figure">
<p><img src="./images/finale-rt-1-multithread.png" alt="finale-rt-1-multithread.png" />
</p>
</div>
</div>
<div id="outline-container-org6af9e8c" class="outline-3">
<h3 id="org6af9e8c"><span class="section-number-3">12.1.</span> Potential Improvements</h3>
<div class="outline-text-3" id="text-12-1">
<p>
I think there is stuff that can be done to improve the performance of this ray tracer.
For one, the tracer has a simple way of casting rays. However, certain parts of the image need
more rays than others. A smarter algorithm for this could work.
(Look into ReSTIR, etc.)
</p>

<p>
As for the code, there might be some improvement that can be done for calculating
the ray bounces.
</p>

<p>
And finally, maybe moving these calculations to the GPU might help?
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<a class="author" href="https://seanzhang.ca">Sean Zhang</a> |
<span class="date">2024-01-10 Wed 21:42</span>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.1 (<a href="https://orgmode.org">Org</a> mode 9.7)</p>
</div>
</body>
</html>
